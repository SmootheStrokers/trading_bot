<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>POLY — Trading Terminal</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
  :root {
    --bg: #0a0a0f;
    --bg2: #111118;
    --bg3: #16161e;
    --bg-card: #0d0d14;
    --border: rgba(255,255,255,0.06);
    --border-hot: rgba(0,212,255,0.35);
    --blue: #00d4ff;
    --blue-dim: rgba(0,212,255,0.12);
    --blue-glow: rgba(0,212,255,0.4);
    --green: #00ff88;
    --green-dim: rgba(0,255,136,0.1);
    --red: #ff3355;
    --red-dim: rgba(255,51,85,0.1);
    --amber: #ffaa00;
    --amber-dim: rgba(255,170,0,0.12);
    --text: #e8e8f0;
    --text-dim: #5a5a7a;
    --text-mid: #9090b0;
    --mono: 'JetBrains Mono', monospace;
    --sans: 'Inter', sans-serif;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: var(--sans);
    font-size: 13px;
    line-height: 1.5;
    min-height: 100vh;
    overflow-x: hidden;
  }

  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image:
      linear-gradient(rgba(0,212,255,0.02) 1px, transparent 1px),
      linear-gradient(90deg, rgba(0,212,255,0.02) 1px, transparent 1px);
    background-size: 32px 32px;
    pointer-events: none;
    z-index: 0;
  }

  .app { position: relative; z-index: 1; min-height: 100vh; display: flex; flex-direction: column; }
  .app[data-loading="true"] .header-stats .hstat-value { opacity: 0.5; }
  .app[data-loading="false"] .header-stats .hstat-value { transition: opacity 0.3s ease; }

  /* ── Header ───────────────────────────────────────────────────────────────── */
  header {
    display: flex;
    align-items: center;
    padding: 0 20px;
    height: 60px;
    border-bottom: 1px solid var(--border);
    background: rgba(10,10,15,0.97);
    backdrop-filter: blur(12px);
    position: sticky;
    top: 0;
    z-index: 100;
    gap: 24px;
  }

  .logo {
    font-family: var(--mono);
    font-size: 16px;
    font-weight: 700;
    letter-spacing: -0.02em;
    color: var(--blue);
    flex-shrink: 0;
  }
  .logo span { color: var(--text-dim); font-weight: 500; }

  .header-stats {
    display: flex;
    gap: 0;
    flex: 1;
    justify-content: center;
    align-items: center;
    overflow-x: auto;
    padding: 0 12px;
  }

  .hstat {
    display: flex;
    flex-direction: column;
    padding: 0 16px;
    border-right: 1px solid var(--border);
    min-width: 100px;
    align-items: flex-start;
  }
  .hstat:last-of-type { border-right: none; }

  .hstat-label {
    font-size: 9px;
    color: var(--text-dim);
    letter-spacing: 0.12em;
    text-transform: uppercase;
    margin-bottom: 2px;
  }

  .hstat-value {
    font-family: var(--mono);
    font-size: 15px;
    font-weight: 700;
    letter-spacing: -0.02em;
  }
  .hstat-value.positive { color: var(--green); text-shadow: 0 0 12px rgba(0,255,136,0.3); }
  .hstat-value.negative { color: var(--red); text-shadow: 0 0 12px rgba(255,51,85,0.3); }
  .hstat-value.blue { color: var(--blue); }
  .hstat-value.glowing-green { color: var(--green); text-shadow: 0 0 16px rgba(0,255,136,0.5); }
  .hstat-value.glowing-red { color: var(--red); text-shadow: 0 0 16px rgba(255,51,85,0.5); }
  .hstat-sub { font-size: 10px; color: var(--text-dim); margin-top: 1px; }

  .cycle-timer-wrap {
    display: flex;
    flex-direction: column;
    gap: 2px;
    padding: 0 16px;
    border-right: 1px solid var(--border);
    min-width: 90px;
  }
  .cycle-label { font-size: 9px; color: var(--text-dim); letter-spacing: 0.1em; text-transform: uppercase; }
  .cycle-value { font-family: var(--mono); font-size: 14px; font-weight: 700; color: var(--blue); }
  .cycle-bar { width: 100%; height: 3px; background: var(--bg3); border-radius: 2px; overflow: hidden; }
  .cycle-bar-fill { height: 100%; background: var(--blue); border-radius: 2px; transition: width 1s linear; }

  .header-right {
    display: flex;
    align-items: center;
    gap: 12px;
    flex-shrink: 0;
  }

  .clock-wrap {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    font-family: var(--mono);
    font-size: 12px;
  }
  .clock-utc { color: var(--blue); font-weight: 600; }
  .clock-local { font-size: 10px; color: var(--text-dim); }

  .conn-indicator {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 10px;
    color: var(--text-dim);
  }
  .conn-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--green);
    box-shadow: 0 0 8px var(--green);
    animation: conn-pulse 2s ease-in-out infinite;
  }
  .conn-dot.disconnected { background: var(--red); box-shadow: 0 0 8px var(--red); animation: none; }

  @keyframes conn-pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.6; }
  }

  .status-pill {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 6px 14px;
    border-radius: 4px;
    font-size: 11px;
    font-weight: 700;
    letter-spacing: 0.1em;
    text-transform: uppercase;
  }
  .status-pill.running { border: 1px solid rgba(0,212,255,0.4); color: var(--blue); background: var(--blue-dim); }
  .status-pill.stopped { border: 1px solid rgba(255,51,85,0.3); color: var(--red); background: var(--red-dim); }
  .status-pill.error { border: 1px solid rgba(255,51,85,0.5); color: var(--red); background: var(--red-dim); }
  .status-pill.paper { border: 1px solid rgba(255,170,0,0.4); color: var(--amber); background: var(--amber-dim); }

  .status-dot { width: 6px; height: 6px; border-radius: 50%; }
  .status-pill.running .status-dot { background: var(--blue); animation: pulse 1.5s ease infinite; }
  .status-pill.stopped .status-dot { background: var(--red); }
  .status-pill.error .status-dot { background: var(--red); }
  .status-pill.paper .status-dot { background: var(--amber); }

  @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }

  .data-pulse { animation: data-pulse 0.5s ease; }
  @keyframes data-pulse { 0% { opacity: 0.5; transform: scale(1.02); } 100% { opacity: 1; transform: scale(1); } }

  /* ── Main Grid (30/40/30) ────────────────────────────────────────────────── */
  .main-grid {
    display: grid;
    grid-template-columns: 30% 40% 30%;
    grid-template-rows: 1fr 1fr;
    grid-template-areas:
      "left center right"
      "left center right";
    gap: 1px;
    background: var(--border);
    flex: 1;
    min-height: calc(100vh - 60px - 140px);
  }
  .col-left { grid-area: left; display: flex; flex-direction: column; gap: 1px; background: var(--border); }
  .col-center { grid-area: center; display: flex; flex-direction: column; min-height: 0; }
  .col-right { grid-area: right; display: flex; flex-direction: column; gap: 1px; background: var(--border); }
  @media (max-width: 1400px) {
    .main-grid { grid-template-columns: 1fr 1fr; grid-template-areas: "left center" "right right"; }
  }
  @media (max-width: 900px) {
    .main-grid { grid-template-columns: 1fr; grid-template-areas: "left" "center" "right"; }
    .header-stats { flex-wrap: wrap; }
  }

  .panel {
    background: var(--bg);
    padding: 16px;
    display: flex;
    flex-direction: column;
    gap: 12px;
    min-height: 0;
  }

  .panel-card {
    background: linear-gradient(135deg, var(--bg-card) 0%, var(--bg2) 100%);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 16px;
    transition: border-color 0.2s, box-shadow 0.2s;
  }
  .panel-card:hover {
    border-color: rgba(0,212,255,0.2);
    box-shadow: 0 0 20px rgba(0,212,255,0.05);
  }

  .panel-title {
    font-size: 10px;
    font-weight: 700;
    letter-spacing: 0.14em;
    text-transform: uppercase;
    color: var(--text-dim);
    display: flex;
    align-items: center;
    gap: 8px;
    padding-bottom: 10px;
    border-bottom: 1px solid var(--border);
    margin-bottom: 4px;
  }
  .panel-title::before {
    content: '';
    width: 3px;
    height: 10px;
    background: var(--blue);
    border-radius: 2px;
  }
  .panel-update { font-size: 9px; color: var(--text-dim); margin-left: auto; }

  /* Left column panels */
  .col-left .panel { background: var(--bg); }

  /* Bot Health */
  .risk-gauge-wrap {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 12px;
  }
  .risk-gauge {
    flex: 1;
    height: 8px;
    background: var(--bg3);
    border-radius: 4px;
    overflow: hidden;
  }
  .risk-gauge-fill {
    height: 100%;
    border-radius: 4px;
    transition: width 0.5s ease, background 0.3s;
  }
  .risk-gauge-fill.safe { background: var(--green); }
  .risk-gauge-fill.warn { background: var(--amber); }
  .risk-gauge-fill.danger { background: var(--red); }

  .strategy-card {
    padding: 10px 12px;
    background: var(--bg2);
    border: 1px solid var(--border);
    border-radius: 4px;
    margin-bottom: 8px;
    font-size: 11px;
  }
  .strategy-name { font-weight: 600; color: var(--text); }
  .strategy-meta { font-size: 10px; color: var(--text-dim); margin-top: 4px; }

  /* Center column */
  .equity-chart-wrap {
    position: relative;
    height: 220px;
    flex: 1;
    min-height: 200px;
  }

  /* Positions table */
  .positions-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 11px;
  }
  .positions-table th {
    text-align: left;
    padding: 8px 10px;
    font-size: 9px;
    font-weight: 600;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: var(--text-dim);
    border-bottom: 1px solid var(--border);
  }
  .positions-table td {
    padding: 10px;
    border-bottom: 1px solid rgba(255,255,255,0.04);
  }
  .positions-table tbody tr { transition: background 0.15s; }
  .positions-table tbody tr:hover { background: rgba(255,255,255,0.02); }
  .positions-table tbody tr.pulse-win { animation: row-pulse-green 0.5s; }
  .positions-table tbody tr.pulse-loss { animation: row-pulse-red 0.5s; }
  @keyframes row-pulse-green { 0% { background: rgba(0,255,136,0.15); } 100% { background: transparent; } }
  @keyframes row-pulse-red { 0% { background: rgba(255,51,85,0.15); } 100% { background: transparent; } }

  .badge-yes { padding: 2px 6px; border-radius: 2px; background: var(--green-dim); color: var(--green); font-size: 9px; font-weight: 700; }
  .badge-no { padding: 2px 6px; border-radius: 2px; background: var(--red-dim); color: var(--red); font-size: 9px; font-weight: 700; }

  .pos-market { max-width: 160px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

  .empty-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 40px 20px;
    color: var(--text-dim);
    font-size: 12px;
  }
  .empty-state svg { width: 48px; height: 48px; opacity: 0.3; margin-bottom: 12px; }

  /* Trade log */
  .trade-log {
    overflow-y: auto;
    max-height: 280px;
    flex: 1;
  }
  .trade-log::-webkit-scrollbar { width: 4px; }
  .trade-log::-webkit-scrollbar-track { background: transparent; }
  .trade-log::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

  .trade-row {
    display: grid;
    grid-template-columns: 48px 1fr 44px 56px 72px 64px 1fr;
    gap: 8px;
    align-items: center;
    padding: 10px 12px;
    font-size: 11px;
    border-bottom: 1px solid rgba(255,255,255,0.04);
    transition: all 0.3s ease;
    animation: tradeSlideIn 0.35s ease;
  }
  @keyframes tradeSlideIn {
    from { opacity: 0; transform: translateX(-12px); }
    to { opacity: 1; transform: translateX(0); }
  }
  .trade-row.win { background: rgba(0,255,136,0.04); }
  .trade-row.loss { background: rgba(255,51,85,0.04); }
  .trade-row:hover { background: rgba(255,255,255,0.03); }

  /* Bot log */
  .log-scroll {
    overflow-y: auto;
    max-height: 200px;
    font-family: var(--mono);
    font-size: 10px;
    line-height: 1.6;
  }
  .log-scroll::-webkit-scrollbar { width: 4px; }
  .log-line { padding: 2px 4px; white-space: pre-wrap; word-break: break-word; }
  .log-line.info { color: rgba(232,232,240,0.65); }
  .log-line.warning { color: var(--amber); }
  .log-line.error { color: var(--red); background: rgba(255,51,85,0.06); }

  /* Market conditions */
  .market-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px solid rgba(255,255,255,0.04);
    font-size: 12px;
  }
  .market-label { color: var(--text-dim); }
  .market-val { font-family: var(--mono); font-weight: 600; }
  .market-val.up { color: var(--green); }
  .market-val.down { color: var(--red); }

  /* Bottom 7-day P&L strip */
  .bottom-pnl-strip {
    height: 120px;
    background: var(--bg2);
    border-top: 1px solid var(--border);
    padding: 16px 24px;
    flex-shrink: 0;
  }
  .bottom-pnl-strip .chart-wrap { height: 88px; }

  /* Skeletons */
  .skeleton {
    background: linear-gradient(90deg, var(--bg3) 25%, var(--bg2) 50%, var(--bg3) 75%);
    background-size: 200% 100%;
    animation: skeleton 1.5s ease-in-out infinite;
    border-radius: 2px;
  }
  @keyframes skeleton {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
  }

  .skeleton-text { height: 14px; }
  .skeleton-value { height: 20px; width: 60%; }
</style>
</head>
<body>
<div class="app">

  <!-- Header -->
  <header>
    <div class="logo">POLY<span>TERMINAL</span></div>

    <div class="header-stats" id="header-stats">
      <div class="hstat">
        <div class="hstat-label">Bankroll</div>
        <div class="hstat-value blue" id="h-bankroll">—</div>
      </div>
      <div class="hstat">
        <div class="hstat-label">Session P&L</div>
        <div class="hstat-value" id="h-pnl">—</div>
        <div class="hstat-sub" id="h-pnl-pct">—</div>
      </div>
      <div class="hstat goal-stat">
        <div class="hstat-label">Daily Goal</div>
        <div class="hstat-value" id="h-goal">—</div>
        <div class="hstat-sub" id="h-goal-pct">—</div>
      </div>
      <div class="hstat">
        <div class="hstat-label">Win Rate</div>
        <div class="hstat-value" id="h-winrate">—</div>
      </div>
      <div class="hstat">
        <div class="hstat-label">Trades Today</div>
        <div class="hstat-value blue" id="h-trades">—</div>
      </div>
    </div>

    <div class="cycle-timer-wrap" id="cycle-timer-wrap">
      <div class="cycle-label">15m Cycle</div>
      <div class="cycle-value" id="cycle-countdown">—:——</div>
      <div class="cycle-bar"><div class="cycle-bar-fill" id="cycle-bar-fill" style="width:100%"></div></div>
    </div>
    <div class="header-right">
      <div class="conn-indicator">
        <div class="conn-dot" id="conn-dot"></div>
        <span id="conn-text">Connecting</span>
      </div>
      <div class="clock-wrap">
        <div class="clock-utc" id="clock-utc">—:—:— UTC</div>
        <div class="clock-local" id="clock-local">—</div>
      </div>
      <div class="status-pill stopped" id="status-pill">
        <div class="status-dot"></div>
        <span id="status-text">STOPPED</span>
      </div>
    </div>
  </header>

  <!-- Main Grid -->
  <div class="main-grid">

    <!-- LEFT COLUMN (30%) -->
    <div class="col-left" style="overflow-y:auto">
      <div class="panel panel-card" style="flex-shrink:0">
        <div class="panel-title">Bot Health <span class="panel-update" id="health-update">—</span></div>
        <div class="risk-gauge-wrap">
          <div class="risk-gauge">
            <div class="risk-gauge-fill safe" id="risk-gauge-fill" style="width:0%"></div>
          </div>
          <span id="risk-pct" style="font-size:10px;color:var(--text-dim)">0%</span>
        </div>
        <div style="font-size:10px;color:var(--text-dim);margin-bottom:12px">Daily loss limit used</div>
        <div id="health-content">
          <div class="market-row"><span class="market-label">Status</span><span class="market-val" id="health-status">—</span></div>
          <div class="market-row"><span class="market-label">Trades/Hour</span><span class="market-val" id="health-trades-hr">—</span></div>
          <div class="market-row"><span class="market-label">Min Edge</span><span class="market-val" id="health-min-edge">—</span></div>
        </div>
        <div class="strategy-cards" id="strategy-cards">
          <div class="strategy-card"><span class="strategy-name">BTC Signal</span><span class="strategy-meta" id="strat-btc">—</span></div>
          <div class="strategy-card"><span class="strategy-name">Maker</span><span class="strategy-meta" id="strat-maker">—</span></div>
        </div>
      </div>

      <div class="panel panel-card">
        <div class="panel-title">Market Conditions <span class="panel-update" id="market-update">—</span></div>
        <div id="market-content">
          <div class="market-row"><span class="market-label">BTC</span><span class="market-val" id="market-btc">—</span></div>
          <div class="market-row"><span class="market-label">ETH</span><span class="market-val" id="market-eth">—</span></div>
          <div class="market-row"><span class="market-label">BTC Funding</span><span class="market-val" id="market-btc-funding">—</span></div>
          <div class="market-row"><span class="market-label">ETH Funding</span><span class="market-val" id="market-eth-funding">—</span></div>
          <div class="market-row"><span class="market-label">Markets Scanned</span><span class="market-val" id="market-scanned">—</span></div>
          <div class="market-row"><span class="market-label">Markets w/ Edge</span><span class="market-val" id="market-edge">—</span></div>
        </div>
      </div>
    </div>

    <!-- CENTER COLUMN (40%) -->
    <div class="col-center panel">
      <div class="panel-title">Equity Curve <span class="panel-update" id="equity-update">—</span></div>
      <div class="equity-chart-wrap">
        <canvas id="equity-chart"></canvas>
      </div>

      <div class="panel-title" style="margin-top:12px">Open Positions <span class="panel-update" id="pos-count-badge">0</span></div>
      <div style="flex:1;min-height:0;overflow:auto">
        <table class="positions-table" id="positions-table">
          <thead>
            <tr>
              <th>Market</th>
              <th>Side</th>
              <th>Size</th>
              <th>Entry</th>
              <th>Price</th>
              <th>P&L</th>
              <th>Open</th>
            </tr>
          </thead>
          <tbody id="positions-body">
            <tr><td colspan="7"><div class="empty-state">No open positions</div></td></tr>
          </tbody>
        </table>
      </div>

      <div class="panel-title" style="margin-top:12px">Goal Progress</div>
      <div class="panel-card" style="padding:12px">
        <div style="display:flex;justify-content:space-between;margin-bottom:8px;font-size:12px">
          <span style="color:var(--text-dim)">Daily P&L</span>
          <span id="goal-daily-pnl" style="font-weight:700">—</span>
        </div>
        <div style="height:6px;background:var(--bg3);border-radius:3px;overflow:hidden;margin-bottom:8px">
          <div id="goal-bar-fill" style="height:100%;width:0%;background:var(--green);border-radius:3px;transition:width 0.5s"></div>
        </div>
        <div style="font-size:11px;color:var(--text-dim)"><span id="goal-progress-text">$0 / $1,000 — 0%</span></div>
      </div>
    </div>

    <!-- RIGHT COLUMN (30%) -->
    <div class="col-right" style="overflow-y:auto">
      <div class="panel panel-card" style="flex:1;min-height:0;display:flex;flex-direction:column">
        <div class="panel-title">Trade Log <span class="panel-update" id="trades-update">—</span></div>
        <div class="trade-log" id="trade-log" style="flex:1">
          <div class="empty-state" id="trades-empty">No trades yet</div>
        </div>
      </div>
      <div class="panel panel-card" style="flex-shrink:0">
        <div class="panel-title">Win / Loss <span class="panel-update" id="winloss-update">—</span></div>
        <div style="height:140px;position:relative">
          <canvas id="winloss-chart"></canvas>
        </div>
      </div>
      <div class="panel panel-card" style="flex-shrink:0;flex:1;min-height:0;display:flex;flex-direction:column">
        <div class="panel-title">Live Log <span class="panel-update" id="log-update">—</span></div>
        <div class="log-scroll" id="log-tail" style="flex:1">
          <div class="log-line info">Connecting...</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bottom 7-day P&L strip -->
  <div class="bottom-pnl-strip">
    <div class="panel-title" style="border:none;padding:0;margin:0 0 8px 0">7-Day P&L</div>
    <div class="chart-wrap">
      <canvas id="daily-pnl-chart"></canvas>
    </div>
  </div>
</div>

<script>
(function() {
  const params = new URLSearchParams(window.location.search);
  const base = params.get('api') || 'http://localhost:8000';
  window.API = base.replace(/\/$/, '');
  window.WS_URL = (base.startsWith('https') ? base.replace('https', 'wss') : base.replace('http', 'ws')).replace(/\/$/, '') + '/ws';
})();
const API = window.API;
const WS_URL = window.WS_URL;

// ── State ────────────────────────────────────────────────────────────────────
let state = {
  running: false, bankroll: null, starting_bankroll: null, session_pnl: 0,
  win_rate: 0, trades_today: 0, open_positions: [], status: 'stopped', paper_trading: false,
};
let trades = [];
let marketPrices = null;
let equityChart = null;
let dailyPnlChart = null;
let winLossChart = null;
let ws = null;
let pollTimers = [];
let hasReceivedData = false;
let lastPnlForGlow = null;

function fmtNum(v, decimals = 2) {
  if (v == null || v === '' || (typeof v === 'number' && isNaN(v))) return '—';
  return typeof v === 'number' ? v.toFixed(decimals) : String(v);
}

// ── Polymarket 15m Cycle Timer ─────────────────────────────────────────────
function getNextQuarterHourUTC() {
  const now = new Date();
  const min = now.getUTCMinutes();
  const nextBoundaryMin = Math.ceil(min / 15) * 15;
  let next = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate(), now.getUTCHours(), 0, 0, 0));
  if (nextBoundaryMin >= 60) { next.setUTCHours(next.getUTCHours() + 1); next.setUTCMinutes(0); }
  else { next.setUTCMinutes(nextBoundaryMin); }
  let ts = next.getTime();
  if (ts <= now.getTime()) ts += 15 * 60 * 1000;
  return ts;
}
function getCurrentCycleStartUTC() {
  const now = new Date();
  const min = now.getUTCMinutes();
  const boundaryMin = Math.floor(min / 15) * 15;
  return new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate(), now.getUTCHours(), boundaryMin, 0, 0)).getTime();
}
function updateCycleTimer() {
  const now = Date.now();
  const nextBoundary = getNextQuarterHourUTC();
  const cycleStart = getCurrentCycleStartUTC();
  const cycleDuration = 15 * 60 * 1000;
  let secsRemaining = Math.floor((nextBoundary - now) / 1000);
  if (secsRemaining <= 0) secsRemaining = 15 * 60;
  const elapsed = now - cycleStart;
  const pctRemaining = Math.min(100, Math.max(0, 100 - (elapsed / cycleDuration) * 100));
  const m = Math.floor(secsRemaining / 60);
  const s = secsRemaining % 60;
  const countEl = document.getElementById('cycle-countdown');
  const barEl = document.getElementById('cycle-bar-fill');
  if (countEl) countEl.textContent = `${m}:${String(s).padStart(2, '0')}`;
  if (barEl) barEl.style.width = pctRemaining + '%';
}

// ── Clock (UTC + local) ─────────────────────────────────────────────────────
function updateClock() {
  const now = new Date();
  const utc = now.toISOString().slice(11, 19);
  const local = now.toLocaleTimeString('en-US', { hour12: false });
  const utcEl = document.getElementById('clock-utc');
  const localEl = document.getElementById('clock-local');
  if (utcEl) utcEl.textContent = utc + ' UTC';
  if (localEl) localEl.textContent = local;
}
setInterval(updateClock, 1000);
updateClock();

// ── Connection status ───────────────────────────────────────────────────────
function setConnected(connected) {
  const dot = document.getElementById('conn-dot');
  const text = document.getElementById('conn-text');
  if (dot) {
    dot.classList.toggle('disconnected', !connected);
  }
  if (text) text.textContent = connected ? 'Live' : 'Disconnected';
}

// ── Charts ──────────────────────────────────────────────────────────────────
function initCharts() {
  const equityCtx = document.getElementById('equity-chart');
  if (equityCtx) {
    equityChart = new Chart(equityCtx.getContext('2d'), {
      type: 'line',
      data: {
        labels: [],
        datasets: [{
          label: 'Equity',
          data: [],
          borderColor: '#00ff88',
          borderWidth: 2,
          fill: true,
          backgroundColor: 'rgba(0,255,136,0.08)',
          tension: 0.35,
          pointRadius: 0,
          pointHoverRadius: 4,
        }]
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        animation: { duration: 400 },
        plugins: {
          legend: { display: false },
          tooltip: {
            backgroundColor: '#111118',
            borderColor: 'rgba(0,212,255,0.3)',
            borderWidth: 1,
            callbacks: { label: c => c.raw != null ? `$${Number(c.raw).toFixed(2)}` : '' }
          }
        },
        scales: {
          x: { display: false },
          y: {
            grid: { color: 'rgba(255,255,255,0.04)' },
            ticks: { color: '#5a5a7a', callback: v => '$' + v }
          }
        }
      }
    });
  }

  const dailyCtx = document.getElementById('daily-pnl-chart');
  if (dailyCtx) {
    dailyPnlChart = new Chart(dailyCtx.getContext('2d'), {
      type: 'bar',
      data: { labels: [], datasets: [{ data: [], backgroundColor: [] }] },
      options: {
        responsive: true, maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: {
          x: { ticks: { color: '#5a5a7a', maxRotation: 0 }, grid: { display: false } },
          y: { ticks: { color: '#5a5a7a', callback: v => '$' + v }, grid: { color: 'rgba(255,255,255,0.04)' } }
        }
      }
    });
  }

  const winLossCtx = document.getElementById('winloss-chart');
  if (winLossCtx) {
    winLossChart = new Chart(winLossCtx.getContext('2d'), {
      type: 'doughnut',
      data: {
        labels: ['Wins', 'Losses'],
        datasets: [{ data: [0, 0], backgroundColor: ['#00ff88', '#ff3355'], borderWidth: 0 }]
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        cutout: '70%',
        plugins: {
          legend: { position: 'bottom', labels: { color: '#9090b0' } },
          tooltip: { callbacks: { label: c => `${c.label}: ${c.raw}` } }
        }
      },
      plugins: [{
        id: 'centerLabel',
        beforeDraw: (chart) => {
          const wins = chart.data.datasets[0].data[0] || 0;
          const losses = chart.data.datasets[0].data[1] || 0;
          const total = wins + losses;
          const pct = total > 0 ? ((wins / total) * 100).toFixed(1) : '0';
          const ctx = chart.ctx;
          ctx.save();
          ctx.font = 'bold 18px JetBrains Mono';
          ctx.fillStyle = '#e8e8f0';
          ctx.textAlign = 'center';
          ctx.textBaseline = 'middle';
          ctx.fillText(pct + '%', chart.width / 2, chart.height / 2);
          ctx.restore();
        }
      }]
    });
  }
}

// ── Update equity chart ─────────────────────────────────────────────────────
function updateEquityChart() {
  if (!equityChart) return;
  const startBr = state.starting_bankroll ?? state.bankroll ?? 1000;
  const closed = (trades || []).filter(t => t.pnl_usdc != null && t.exit_time);
  closed.sort((a,b) => (a.exit_time||'').localeCompare(b.exit_time||''));

  const labels = [];
  const data = [];
  let running = startBr;
  for (const t of closed) {
    running += parseFloat(t.pnl_usdc || 0);
    labels.push((t.exit_time||'').slice(11, 16) || '—');
    data.push(parseFloat(running.toFixed(2)));
  }
  if (closed.length > 0) {
    labels.push('Now');
    data.push(state.bankroll ?? running);
  } else if (state.bankroll != null) {
    labels.push('Now');
    data.push(state.bankroll);
  } else {
    labels.push('Start');
    data.push(startBr);
  }

  equityChart.data.labels = labels;
  equityChart.data.datasets[0].data = data;
  equityChart.update('none');

  const up = document.getElementById('equity-update');
  if (up && hasReceivedData) up.textContent = new Date().toLocaleTimeString('en-US', { hour12: false });
}

// ── Update daily P&L chart ──────────────────────────────────────────────────
async function updateDailyPnlChart() {
  try {
    const res = await fetch(`${API}/api/chart-data`).then(r => r.json()).catch(() => null);
    if (res && dailyPnlChart && res.daily_pnl_7d && res.daily_pnl_7d.length) {
      const d = [...res.daily_pnl_7d].reverse();
      const today = new Date().toISOString().slice(0, 10);
      dailyPnlChart.data.labels = d.map(x => {
        const label = x.date.slice(5);
        return label === today.slice(5) ? label + ' ★' : label;
      });
      dailyPnlChart.data.datasets[0].data = d.map(x => x.pnl);
      dailyPnlChart.data.datasets[0].backgroundColor = d.map((x, i) => {
        const isToday = d[i].date === today;
        const base = x.pnl >= 0 ? 'rgba(0,255,136,0.7)' : 'rgba(255,51,85,0.7)';
        return isToday ? (x.pnl >= 0 ? 'rgba(0,255,136,0.9)' : 'rgba(255,51,85,0.9)') : base;
      });
      dailyPnlChart.update('none');
    }
  } catch (_) {}
}

// ── Render Header ───────────────────────────────────────────────────────────
function renderHeader(s) {
  const bankroll = s.bankroll ?? s.starting_bankroll;
  const start = s.starting_bankroll ?? bankroll ?? 1000;
  const curr = bankroll ?? start;
  const sessionPnl = s.session_pnl ?? 0;
  const pnlPct = s.session_pnl_pct ?? (start > 0 ? (sessionPnl / start) * 100 : 0);
  const goalTrack = s.goal_tracking || {};
  const goal = goalTrack.daily_goal_usd ?? 1000;
  const dailyPnl = goalTrack.daily_pnl ?? sessionPnl;
  const progressPct = goalTrack.progress_pct ?? (goal > 0 ? (dailyPnl / goal) * 100 : 0);

  const bankrollEl = document.getElementById('h-bankroll');
  if (bankrollEl) {
    setWithPulse(bankrollEl, curr != null ? '$' + fmtNum(curr) : '—');
    bankrollEl.className = 'hstat-value ' + (sessionPnl >= 0 ? 'glowing-green' : sessionPnl < 0 ? 'glowing-red' : 'blue');
  }

  const pnlEl = document.getElementById('h-pnl');
  if (pnlEl) {
    setWithPulse(pnlEl, sessionPnl != null ? (sessionPnl >= 0 ? '+' : '') + '$' + fmtNum(sessionPnl) : '—');
    pnlEl.className = 'hstat-value ' + (sessionPnl >= 0 ? 'positive' : 'negative');
  }
  const pctEl = document.getElementById('h-pnl-pct');
  if (pctEl) pctEl.textContent = pnlPct != null ? (pnlPct >= 0 ? '+' : '') + fmtNum(pnlPct) + '%' : '—';

  const goalEl = document.getElementById('h-goal');
  if (goalEl) goalEl.textContent = dailyPnl != null && goal != null ? `$${fmtNum(dailyPnl)} / $${fmtNum(goal)}` : '—';
  const goalPctEl = document.getElementById('h-goal-pct');
  if (goalPctEl) goalPctEl.textContent = progressPct != null ? fmtNum(progressPct) + '%' : '—';

  const wrEl = document.getElementById('h-winrate');
  if (wrEl) wrEl.textContent = (s.win_rate ?? s.trade_stats?.win_rate_all) != null ? fmtNum(s.win_rate ?? s.trade_stats?.win_rate_all, 1) + '%' : '—';

  const tradesEl = document.getElementById('h-trades');
  if (tradesEl) tradesEl.textContent = (s.trades_today ?? s.trade_stats?.trades_today ?? 0);

  // Status pill
  const pill = document.getElementById('status-pill');
  const txt = document.getElementById('status-text');
  const st = s.status ?? (s.running ? 'running' : 'stopped');
  if (pill && txt) {
    pill.className = 'status-pill ' + (s.paper_trading ? 'paper' : st);
    txt.textContent = s.paper_trading ? 'PAPER' : st === 'running' ? 'LIVE' : st === 'error' ? 'ERROR' : 'STOPPED';
  }
}

// ── Render Goal ─────────────────────────────────────────────────────────────
function renderGoal(s) {
  const gt = s.goal_tracking || {};
  const dailyPnl = gt.daily_pnl ?? s.session_pnl ?? 0;
  const goal = gt.daily_goal_usd ?? 1000;
  const progressPct = Math.min(100, Math.max(0, goal > 0 ? (dailyPnl / goal) * 100 : 0));

  const pnlEl = document.getElementById('goal-daily-pnl');
  if (pnlEl) {
    pnlEl.textContent = dailyPnl != null ? (dailyPnl >= 0 ? '+' : '') + '$' + fmtNum(dailyPnl) : '—';
    pnlEl.style.color = dailyPnl >= 0 ? 'var(--green)' : 'var(--red)';
  }
  const barFill = document.getElementById('goal-bar-fill');
  if (barFill) {
    barFill.style.width = progressPct + '%';
    barFill.style.background = dailyPnl >= 0 ? 'var(--green)' : 'var(--red)';
  }
  const progEl = document.getElementById('goal-progress-text');
  if (progEl) progEl.textContent = `$${fmtNum(dailyPnl)} / $${fmtNum(goal)} — ${fmtNum(progressPct, 1)}%`;
}

// ── Render Health ───────────────────────────────────────────────────────────
function renderHealth(s) {
  const lossPct = s.daily_loss_limit_used_pct ?? 0;
  const bar = document.getElementById('risk-gauge-fill');
  const pctEl = document.getElementById('risk-pct');
  if (bar) {
    bar.style.width = Math.min(100, lossPct) + '%';
    bar.className = 'risk-gauge-fill ' + (lossPct > 80 ? 'danger' : lossPct > 50 ? 'warn' : 'safe');
  }
  if (pctEl) pctEl.textContent = fmtNum(lossPct, 0) + '%';

  const set = (id, v) => { const e = document.getElementById(id); if (e) e.textContent = v != null && v !== '' ? v : '—'; };
  set('health-status', s.running ? 'Scanning' : 'Stopped');
  set('health-trades-hr', s.trade_stats?.trades_per_hour != null ? fmtNum(s.trade_stats.trades_per_hour, 1) : '—');
  set('health-min-edge', s.config?.min_edge_pct != null ? s.config.min_edge_pct + '%' : '—');

  const btcEl = document.getElementById('strat-btc');
  if (btcEl) {
    const a = s.bot_activity || {};
    if (a.btc_signal_fired && a.btc_signal_side && a.btc_pct_move != null) {
      btcEl.textContent = `${a.btc_signal_side} ${(a.btc_pct_move * 100).toFixed(2)}%`;
      btcEl.style.color = 'var(--green)';
    } else {
      btcEl.textContent = 'Inactive';
      btcEl.style.color = 'var(--text-dim)';
    }
  }
  const makerEl = document.getElementById('strat-maker');
  if (makerEl) {
    makerEl.textContent = s.bot_activity?.maker_active ? 'Active' : 'Off';
    makerEl.style.color = s.bot_activity?.maker_active ? 'var(--green)' : 'var(--text-dim)';
  }

  const up = document.getElementById('health-update');
  if (up && hasReceivedData) up.textContent = new Date().toLocaleTimeString('en-US', { hour12: false });
}

// ── Render Market ───────────────────────────────────────────────────────────
function renderMarket(s, prices) {
  const set = (id, v) => { const e = document.getElementById(id); if (e) e.textContent = v != null && v !== '' ? v : '—'; };
  set('market-scanned', s.bot_activity?.markets_last_scan);
  set('market-edge', s.bot_activity?.markets_with_edge);

  if (prices) {
    if (prices.btc_usd != null) {
      const el = document.getElementById('market-btc');
      if (el) {
        const change = prices.btc_24h_change;
        el.innerHTML = '$' + Number(prices.btc_usd).toLocaleString(undefined, {maximumFractionDigits: 0}) +
          (change != null ? ` <span class="${change >= 0 ? 'up' : 'down'}">(${change >= 0 ? '+' : ''}${Number(change).toFixed(2)}%)</span>` : '');
      }
    } else set('market-btc', '—');
    if (prices.eth_usd != null) {
      const el = document.getElementById('market-eth');
      if (el) {
        const change = prices.eth_24h_change;
        el.innerHTML = '$' + Number(prices.eth_usd).toLocaleString(undefined, {maximumFractionDigits: 0}) +
          (change != null ? ` <span class="${change >= 0 ? 'up' : 'down'}">(${change >= 0 ? '+' : ''}${Number(change).toFixed(2)}%)</span>` : '');
      }
    } else set('market-eth', '—');
    const btcFr = prices.btc_funding;
    const ethFr = prices.eth_funding;
    const frStr = (v, label) => v != null ? v.toFixed(4) + '% ' + (v > 0 ? '(longs pay)' : v < 0 ? '(shorts pay)' : '') : '—';
    const btcFrEl = document.getElementById('market-btc-funding');
    const ethFrEl = document.getElementById('market-eth-funding');
    if (btcFrEl) btcFrEl.textContent = frStr(btcFr, 'BTC');
    if (ethFrEl) ethFrEl.textContent = frStr(ethFr, 'ETH');
  } else {
    set('market-btc', '—');
    set('market-eth', '—');
    set('market-btc-funding', '—');
    set('market-eth-funding', '—');
  }

  const up = document.getElementById('market-update');
  if (up && hasReceivedData) up.textContent = new Date().toLocaleTimeString('en-US', { hour12: false });
}

// ── Render Positions ─────────────────────────────────────────────────────────
function renderPositions(positions) {
  const tbody = document.getElementById('positions-body');
  const badge = document.getElementById('pos-count-badge');
  if (!tbody) return;

  if (!positions || positions.length === 0) {
    tbody.innerHTML = '<tr><td colspan="7"><div class="empty-state">No open positions</div></td></tr>';
    if (badge) badge.textContent = '0';
    return;
  }

  if (badge) badge.textContent = positions.length;

  tbody.innerHTML = positions.map(pos => {
    const entryP = parseFloat(pos.entry_price || 0);
    const currP = parseFloat(pos.current_price || entryP);
    const shares = parseFloat(pos.shares || 0);
    const pnl = (currP - entryP) * shares;
    const sizeUsdc = parseFloat(pos.size_usdc || 0);
    const entryTime = pos.entry_time ? new Date(pos.entry_time) : null;
    const openDur = entryTime ? formatDuration((Date.now() - entryTime.getTime()) / 1000) : '—';

    return `<tr>
      <td class="pos-market" title="${escHtml(pos.question||'')}">${escHtml((pos.question||'').slice(0, 35))}</td>
      <td><span class="badge-${(pos.side||'').toLowerCase()}">${pos.side || '?'}</span></td>
      <td>$${fmtNum(sizeUsdc)}</td>
      <td>${fmtNum(entryP, 3)}</td>
      <td>${fmtNum(currP, 3)}</td>
      <td style="color:${pnl >= 0 ? 'var(--green)' : 'var(--red)'};font-weight:600">${pnl >= 0 ? '+' : ''}$${fmtNum(pnl)}</td>
      <td>${openDur}</td>
    </tr>`;
  }).join('');
}

// ── Render Trades ───────────────────────────────────────────────────────────
function renderTrades(tradeList) {
  const container = document.getElementById('trade-log');
  const empty = document.getElementById('trades-empty');
  const updateEl = document.getElementById('trades-update');

  if (!container) return;
  if (updateEl && hasReceivedData) updateEl.textContent = new Date().toLocaleTimeString('en-US', { hour12: false });

  if (!tradeList || tradeList.length === 0) {
    container.innerHTML = '<div class="empty-state" id="trades-empty">No trades yet</div>';
    return;
  }

  const sorted = [...tradeList].sort((a,b) => (b.exit_time||'').localeCompare(a.exit_time||''));
  const existing = container.querySelectorAll('.trade-row');
  const frag = document.createDocumentFragment();

  sorted.slice(0, 50).forEach((t, i) => {
    const pnl = parseFloat(t.pnl_usdc || 0);
    const isWin = pnl > 0;
    const row = document.createElement('div');
    row.className = 'trade-row ' + (isWin ? 'win' : 'loss');
    row.innerHTML = `
      <span>${(t.exit_time||'').slice(11, 19)}</span>
      <span class="pos-market" title="${escHtml(t.question||'')}">${escHtml((t.question||'').slice(0, 25))}</span>
      <span class="badge-${(t.side||'').toLowerCase()}">${t.side||'?'}</span>
      <span>$${fmtNum(parseFloat(t.size_usdc||0))}</span>
      <span>${fmtNum(parseFloat(t.entry_price||0), 2)}→${t.exit_price ? fmtNum(parseFloat(t.exit_price), 2) : '—'}</span>
      <span style="color:${isWin ? 'var(--green)' : 'var(--red)'};font-weight:600">${pnl >= 0 ? '+' : ''}$${fmtNum(pnl)}</span>
      <span>${(t.strategy||'—').replace(/_/g,' ')}</span>
    `;
    frag.appendChild(row);
  });

  container.innerHTML = '';
  container.appendChild(frag);
}

// ── Render Win/Loss chart ───────────────────────────────────────────────────
function updateWinLossChart() {
  if (!winLossChart) return;
  const closed = (trades || []).filter(t => t.pnl_usdc != null && t.exit_time);
  const wins = closed.filter(t => parseFloat(t.pnl_usdc || 0) > 0).length;
  const losses = closed.length - wins;
  winLossChart.data.datasets[0].data = [wins, losses];
  winLossChart.update('none');

  const up = document.getElementById('winloss-update');
  if (up && hasReceivedData) up.textContent = new Date().toLocaleTimeString('en-US', { hour12: false });
}

// ── Render Logs ─────────────────────────────────────────────────────────────
function renderLogs(lines) {
  const el = document.getElementById('log-tail');
  const up = document.getElementById('log-update');
  if (up && hasReceivedData) up.textContent = new Date().toLocaleTimeString('en-US', { hour12: false });
  if (!el) return;

  el.innerHTML = (lines || []).map(line => {
    const lvl = line.includes('| ERROR') ? 'error' : line.includes('| WARNING') ? 'warning' : 'info';
    return `<div class="log-line ${lvl}">${escHtml(line)}</div>`;
  }).join('') || '<div class="log-line info">No log output</div>';

  el.scrollTop = el.scrollHeight;
}

// ── Helpers ─────────────────────────────────────────────────────────────────
function formatDuration(secs) {
  secs = Math.max(0, Math.floor(secs));
  const m = Math.floor(secs / 60);
  const s = secs % 60;
  return `${m}:${String(s).padStart(2, '0')}`;
}

function escHtml(str) {
  return String(str||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

function setWithPulse(el, text) {
  if (!el) return;
  if (el.textContent !== text) {
    el.textContent = text;
    el.classList.remove('data-pulse');
    void el.offsetWidth;
    el.classList.add('data-pulse');
    setTimeout(() => el.classList.remove('data-pulse'), 500);
  }
}

// ── WebSocket ───────────────────────────────────────────────────────────────
function connectWS() {
  try {
    ws = new WebSocket(WS_URL);

    ws.onopen = () => {
      setConnected(true);
      renderLogs(['Connected to bot WebSocket']);
    };

    ws.onmessage = (evt) => {
      try {
        const msg = JSON.parse(evt.data);
        if (msg.type === 'update') {
          hasReceivedData = true;
          document.querySelector('.app')?.setAttribute('data-loading', 'false');
          state = { ...state, ...(msg.status || {}) };
          if (Array.isArray(msg.recent_trades) && msg.recent_trades.length > 0) trades = msg.recent_trades;

          renderHeader(state);
          renderGoal(state);
          renderHealth(state);
          renderPositions(state.open_positions || []);
          renderMarket(state, marketPrices);
          renderTrades(trades);
          updateEquityChart();
          updateWinLossChart();
          updateDailyPnlChart();
          if (msg.logs) renderLogs(msg.logs);
        }
      } catch (e) { console.error('WS parse error', e); }
    };

    ws.onerror = () => {
      setConnected(false);
      renderLogs(['WebSocket error — check server']);
    };

    ws.onclose = () => {
      setConnected(false);
      renderLogs(['Disconnected. Reconnecting...']);
      setTimeout(connectWS, 3000);
    };
  } catch (e) {
    setConnected(false);
    renderLogs(['WebSocket failed: ' + (e.message || 'unknown')]);
    setTimeout(connectWS, 3000);
  }
}

// ── Polling fallback & balance / market ─────────────────────────────────────
async function pollStatus() {
  if (ws && ws.readyState === WebSocket.OPEN) return;
  try {
    const res = await fetch(`${API}/api/status`).then(r => r.json()).catch(() => null);
    if (res) {
      hasReceivedData = true;
      document.querySelector('.app')?.setAttribute('data-loading', 'false');
      state = { ...state, ...res };
      renderHeader(state);
      renderGoal(state);
      renderHealth(state);
      renderPositions(state.open_positions || []);
      renderMarket(state, marketPrices);
    }
  } catch (_) {}
}

async function pollTrades() {
  try {
    const res = await fetch(`${API}/api/trades`).then(r => r.json()).catch(() => null);
    if (res && res.trades && res.trades.length > 0) {
      trades = res.trades;
      renderTrades(trades);
      updateEquityChart();
      updateWinLossChart();
    }
  } catch (_) {}
}

async function pollLogs() {
  if (ws && ws.readyState === WebSocket.OPEN) return;
  try {
    const res = await fetch(`${API}/api/logs`).then(r => r.json()).catch(() => null);
    if (res && res.lines) renderLogs(res.lines);
  } catch (_) {}
}

async function pollBalance() {
  try {
    const res = await fetch(`${API}/api/balance`).then(r => r.json()).catch(() => null);
    if (res && res.balance_usdc != null) {
      state.bankroll = res.balance_usdc;
      state.starting_bankroll = res.starting_bankroll ?? state.starting_bankroll;
      state.session_pnl = res.session_pnl ?? state.session_pnl;
      renderHeader(state);
      renderGoal(state);
      updateEquityChart();
    }
  } catch (_) {}
}

async function pollMarketPrices() {
  try {
    const res = await fetch(`${API}/api/market-prices`).then(r => r.json()).catch(() => null);
    if (res) {
      marketPrices = res;
      renderMarket(state, marketPrices);
    }
  } catch (_) {}
}

// ── Init ────────────────────────────────────────────────────────────────────
document.addEventListener('DOMContentLoaded', () => {
  initCharts();
  connectWS();

  const interval = 8000;
  pollTimers.push(setInterval(pollStatus, interval));
  pollTimers.push(setInterval(pollTrades, interval));
  pollTimers.push(setInterval(pollLogs, interval));
  pollTimers.push(setInterval(pollBalance, interval));
  pollTimers.push(setInterval(pollMarketPrices, interval));

  updateCycleTimer();
  setInterval(updateCycleTimer, 1000);

  // Initial fetch (allSettled = one failure doesn't break others)
  Promise.allSettled([
    fetch(`${API}/api/status`).then(r => r.json()),
    fetch(`${API}/api/trades`).then(r => r.json()),
    fetch(`${API}/api/logs`).then(r => r.json()),
    fetch(`${API}/api/market-prices`).then(r => r.json()),
    fetch(`${API}/api/balance`).then(r => r.json()),
  ]).then(([s, t, l, p, b]) => {
    const status = s.status === 'fulfilled' ? s.value : null;
    const tradesRes = t.status === 'fulfilled' ? t.value : null;
    const logsRes = l.status === 'fulfilled' ? l.value : null;
    const prices = p.status === 'fulfilled' ? p.value : null;
    const balance = b.status === 'fulfilled' ? b.value : null;
    if (status) { state = { ...state, ...status }; renderHeader(state); renderGoal(state); renderHealth(state); renderPositions(state.open_positions||[]); }
    if (tradesRes?.trades?.length) { trades = tradesRes.trades; renderTrades(trades); updateEquityChart(); updateWinLossChart(); }
    if (logsRes?.lines) renderLogs(logsRes.lines);
    if (prices) { marketPrices = prices; renderMarket(state, marketPrices); }
    if (balance && balance.balance_usdc != null) { state.bankroll = balance.balance_usdc; state.starting_bankroll = balance.starting_bankroll; state.session_pnl = balance.session_pnl; renderHeader(state); renderGoal(state); }
    updateDailyPnlChart();
    hasReceivedData = true;
    setConnected(true);
    document.querySelector('.app')?.setAttribute('data-loading', 'false');
  }).catch(() => { document.querySelector('.app')?.setAttribute('data-loading', 'false'); });
  document.querySelector('.app')?.setAttribute('data-loading', 'true');
});

window.addEventListener('beforeunload', () => {
  pollTimers.forEach(t => clearInterval(t));
  if (ws) ws.close();
});
</script>
</body>
</html>
