<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>POLY — Trading Terminal</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
  :root {
    --bg: #050508;
    --bg2: #0a0a0f;
    --bg3: #0e0e14;
    --bg-card: #08080c;
    --border: rgba(255,255,255,0.04);
    --border-hot: rgba(0,212,255,0.5);
    --blue: #00d4ff;
    --blue-dim: rgba(0,212,255,0.08);
    --blue-glow: rgba(0,212,255,0.5);
    --cyan: #22d3ee;
    --green: #00ff88;
    --green-dim: rgba(0,255,136,0.08);
    --green-glow: rgba(0,255,136,0.6);
    --red: #ff3366;
    --red-dim: rgba(255,51,102,0.08);
    --red-glow: rgba(255,51,102,0.5);
    --amber: #fbbf24;
    --amber-dim: rgba(251,191,36,0.1);
    --magenta: #e879f9;
    --text: #f0f0f8;
    --text-dim: #4a4a6a;
    --text-mid: #7878a0;
    --mono: 'JetBrains Mono', monospace;
    --sans: 'Orbitron', sans-serif;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: var(--sans);
    font-size: 13px;
    line-height: 1.5;
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* Epic cinematic background */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background: radial-gradient(ellipse 120% 80% at 50% -20%, rgba(0,212,255,0.08) 0%, transparent 50%),
                radial-gradient(ellipse 80% 60% at 90% 50%, rgba(232,121,249,0.04) 0%, transparent 40%),
                radial-gradient(ellipse 60% 80% at 10% 80%, rgba(0,255,136,0.03) 0%, transparent 40%);
    pointer-events: none;
    z-index: 0;
  }

  body::after {
    content: '';
    position: fixed;
    inset: 0;
    background-image:
      linear-gradient(rgba(0,212,255,0.015) 1px, transparent 1px),
      linear-gradient(90deg, rgba(0,212,255,0.015) 1px, transparent 1px);
    background-size: 24px 24px;
    mask-image: radial-gradient(ellipse 80% 80% at 50% 50%, black 20%, transparent 70%);
    -webkit-mask-image: radial-gradient(ellipse 80% 80% at 50% 50%, black 20%, transparent 70%);
    pointer-events: none;
    z-index: 0;
  }

  /* Scan line overlay */
  .scanlines {
    position: fixed;
    inset: 0;
    background: repeating-linear-gradient(
      0deg,
      transparent,
      transparent 2px,
      rgba(0,0,0,0.03) 2px,
      rgba(0,0,0,0.03) 4px
    );
    pointer-events: none;
    z-index: 1;
  }

  /* Corner brackets - futuristic frame */
  .corner-brackets {
    position: fixed;
    inset: 0;
    pointer-events: none;
    z-index: 1;
    border: 1px solid rgba(0,212,255,0.15);
    box-shadow: inset 0 0 60px rgba(0,212,255,0.03);
  }
  .corner-brackets::before,
  .corner-brackets::after {
    content: '';
    position: absolute;
    width: 20px;
    height: 20px;
    border-color: var(--blue);
    border-style: solid;
    border-width: 2px 0 0 2px;
    top: 64px;
    left: 0;
  }
  .corner-brackets::after {
    left: auto;
    right: 0;
    border-width: 2px 2px 0 0;
  }

  .app { position: relative; z-index: 2; min-height: 100vh; display: flex; flex-direction: column; }
  .app[data-loading="true"] .header-stats .hstat-value { opacity: 0.5; }
  .app[data-loading="false"] .header-stats .hstat-value { transition: opacity 0.3s ease; }

  /* ── Header ───────────────────────────────────────────────────────────────── */
  header {
    display: flex;
    align-items: center;
    padding: 0 24px;
    height: 64px;
    border-bottom: 1px solid var(--border);
    background: linear-gradient(180deg, rgba(8,8,14,0.98) 0%, rgba(5,5,10,0.95) 100%);
    backdrop-filter: blur(20px) saturate(1.2);
    -webkit-backdrop-filter: blur(20px) saturate(1.2);
    box-shadow: 0 4px 30px rgba(0,0,0,0.4), inset 0 1px 0 rgba(255,255,255,0.02);
    position: sticky;
    top: 0;
    z-index: 100;
    gap: 24px;
  }

  .logo {
    font-family: var(--mono);
    font-size: 18px;
    font-weight: 700;
    letter-spacing: -0.03em;
    background: linear-gradient(135deg, var(--blue) 0%, var(--cyan) 50%, var(--magenta) 100%);
    background-size: 200% auto;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    animation: gradient-shift 8s ease infinite;
    flex-shrink: 0;
  }
  .logo span { -webkit-text-fill-color: var(--text-dim); }
  @keyframes gradient-shift {
    0%, 100% { background-position: 0% center; }
    50% { background-position: 100% center; }
  }

  .header-stats {
    display: flex;
    gap: 0;
    flex: 1;
    justify-content: center;
    align-items: center;
    overflow-x: auto;
    padding: 0 16px;
  }

  .hstat {
    display: flex;
    flex-direction: column;
    padding: 0 20px;
    border-right: 1px solid var(--border);
    min-width: 110px;
    align-items: flex-start;
  }
  .hstat:last-of-type { border-right: none; }

  .hstat-label {
    font-size: 9px;
    color: var(--text-dim);
    letter-spacing: 0.15em;
    text-transform: uppercase;
    margin-bottom: 4px;
  }

  .hstat-value {
    font-family: var(--mono);
    font-size: 16px;
    font-weight: 700;
    letter-spacing: -0.02em;
  }
  .hstat-value.positive { color: var(--green); text-shadow: 0 0 20px var(--green-glow), 0 0 40px rgba(0,255,136,0.2); }
  .hstat-value.negative { color: var(--red); text-shadow: 0 0 20px var(--red-glow), 0 0 40px rgba(255,51,102,0.2); }
  .hstat-value.blue { color: var(--blue); text-shadow: 0 0 16px var(--blue-glow); }
  .hstat-value.glowing-green { color: var(--green); text-shadow: 0 0 24px var(--green-glow), 0 0 48px rgba(0,255,136,0.25); }
  .hstat-value.glowing-red { color: var(--red); text-shadow: 0 0 24px var(--red-glow), 0 0 48px rgba(255,51,102,0.25); }
  .hstat-sub { font-size: 10px; color: var(--text-dim); margin-top: 2px; }

  .cycle-timer-wrap {
    display: flex;
    flex-direction: column;
    gap: 4px;
    padding: 0 20px;
    border-right: 1px solid var(--border);
    min-width: 100px;
  }
  .cycle-label { font-size: 9px; color: var(--text-dim); letter-spacing: 0.1em; text-transform: uppercase; }
  .cycle-value { font-family: var(--mono); font-size: 15px; font-weight: 700; color: var(--blue); text-shadow: 0 0 12px var(--blue-glow); }
  .cycle-bar { width: 100%; height: 4px; background: var(--bg3); border-radius: 2px; overflow: hidden; }
  .cycle-bar-fill { height: 100%; background: linear-gradient(90deg, var(--blue), var(--cyan)); border-radius: 2px; transition: width 1s linear; box-shadow: 0 0 8px var(--blue-glow); }

  .header-right {
    display: flex;
    align-items: center;
    gap: 16px;
    flex-shrink: 0;
  }

  .clock-wrap {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    font-family: var(--mono);
    font-size: 12px;
  }
  .clock-utc { color: var(--blue); font-weight: 600; text-shadow: 0 0 10px rgba(0,212,255,0.3); }
  .clock-local { font-size: 10px; color: var(--text-dim); }

  .conn-indicator {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 10px;
    color: var(--text-dim);
  }
  .conn-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: var(--green);
    box-shadow: 0 0 12px var(--green), 0 0 24px rgba(0,255,136,0.4);
    animation: conn-pulse 2s ease-in-out infinite;
  }
  .conn-dot.disconnected { background: var(--red); box-shadow: 0 0 12px var(--red); animation: none; }

  @keyframes conn-pulse {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.7; transform: scale(0.9); }
  }

  .status-pill {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px 18px;
    border-radius: 6px;
    font-size: 11px;
    font-weight: 700;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    transition: all 0.3s ease;
  }
  .status-pill.running {
    border: 1px solid rgba(0,212,255,0.5);
    color: var(--blue);
    background: linear-gradient(135deg, rgba(0,212,255,0.1) 0%, rgba(0,212,255,0.02) 100%);
    box-shadow: 0 0 20px rgba(0,212,255,0.15), inset 0 1px 0 rgba(255,255,255,0.05);
  }
  .status-pill.stopped {
    border: 1px solid rgba(255,51,102,0.4);
    color: var(--red);
    background: linear-gradient(135deg, rgba(255,51,102,0.08) 0%, transparent 100%);
  }
  .status-pill.error {
    border: 1px solid rgba(255,51,102,0.6);
    color: var(--red);
    background: linear-gradient(135deg, rgba(255,51,102,0.12) 0%, transparent 100%);
    box-shadow: 0 0 16px rgba(255,51,102,0.2);
  }
  .status-pill.paper {
    border: 1px solid rgba(251,191,36,0.5);
    color: var(--amber);
    background: linear-gradient(135deg, rgba(251,191,36,0.1) 0%, transparent 100%);
  }

  .status-dot { width: 8px; height: 8px; border-radius: 50%; }
  .status-pill.running .status-dot { background: var(--blue); box-shadow: 0 0 8px var(--blue); animation: pulse 1.5s ease infinite; }
  .status-pill.stopped .status-dot { background: var(--red); }
  .status-pill.error .status-dot { background: var(--red); box-shadow: 0 0 8px var(--red); }
  .status-pill.paper .status-dot { background: var(--amber); }

  @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }

  .data-pulse { animation: data-pulse 0.5s ease; }
  @keyframes data-pulse { 0% { opacity: 0.5; transform: scale(1.03); } 100% { opacity: 1; transform: scale(1); } }

  /* ── Main Grid (30/40/30) ────────────────────────────────────────────────── */
  .main-grid {
    display: grid;
    grid-template-columns: 30% 40% 30%;
    grid-template-rows: 1fr 1fr;
    grid-template-areas:
      "left center right"
      "left center right";
    gap: 1px;
    background: var(--border);
    flex: 1;
    min-height: calc(100vh - 64px - 260px);
  }
  .col-left { grid-area: left; display: flex; flex-direction: column; gap: 1px; background: var(--border); }
  .col-center { grid-area: center; display: flex; flex-direction: column; min-height: 0; }
  .col-right { grid-area: right; display: flex; flex-direction: column; gap: 1px; background: var(--border); }
  @media (max-width: 1400px) {
    .main-grid { grid-template-columns: 1fr 1fr; grid-template-areas: "left center" "right right"; }
  }
  @media (max-width: 900px) {
    .main-grid { grid-template-columns: 1fr; grid-template-areas: "left" "center" "right"; }
    .header-stats { flex-wrap: wrap; }
  }

  .panel {
    background: var(--bg);
    padding: 18px;
    display: flex;
    flex-direction: column;
    gap: 14px;
    min-height: 0;
  }

  .panel-card {
    position: relative;
    background: linear-gradient(145deg, rgba(10,10,16,0.9) 0%, rgba(6,6,12,0.95) 100%);
    border: 1px solid rgba(255,255,255,0.06);
    border-radius: 12px;
    padding: 18px;
    overflow: hidden;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  }
  .panel-card::before {
    content: '';
    position: absolute;
    inset: 0;
    border-radius: 12px;
    padding: 1px;
    background: linear-gradient(135deg, rgba(0,212,255,0.15) 0%, transparent 40%, transparent 60%, rgba(232,121,249,0.08) 100%);
    -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
    mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
    -webkit-mask-composite: xor;
    mask-composite: exclude;
    pointer-events: none;
    opacity: 0;
  }
  .panel-card:hover {
    border-color: rgba(0,212,255,0.25);
    box-shadow: 0 0 40px rgba(0,212,255,0.08), 0 8px 32px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.02);
    transform: translateY(-1px);
  }
  .panel-card:hover::before { opacity: 1; }

  .panel-title {
    font-size: 10px;
    font-weight: 700;
    letter-spacing: 0.16em;
    text-transform: uppercase;
    color: var(--text-dim);
    display: flex;
    align-items: center;
    gap: 10px;
    padding-bottom: 12px;
    border-bottom: 1px solid var(--border);
    margin-bottom: 6px;
  }
  .panel-title::before {
    content: '';
    width: 4px;
    height: 12px;
    background: linear-gradient(180deg, var(--blue), var(--cyan));
    border-radius: 2px;
    box-shadow: 0 0 10px var(--blue-glow);
    animation: titleGlow 3s ease-in-out infinite;
  }
  @keyframes titleGlow {
    0%, 100% { opacity: 1; box-shadow: 0 0 10px var(--blue-glow); }
    50% { opacity: 0.8; box-shadow: 0 0 16px var(--blue-glow); }
  }
  .panel-update { font-size: 9px; color: var(--text-dim); margin-left: auto; }

  /* Left column panels */
  .col-left .panel { background: var(--bg); }

  /* Bot Health */
  .risk-gauge-wrap {
    display: flex;
    align-items: center;
    gap: 14px;
    margin-bottom: 14px;
  }
  .risk-gauge {
    flex: 1;
    height: 10px;
    background: var(--bg3);
    border-radius: 5px;
    overflow: hidden;
    box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);
  }
  .risk-gauge-fill {
    height: 100%;
    border-radius: 5px;
    transition: width 0.5s ease, background 0.3s, box-shadow 0.3s;
  }
  .risk-gauge-fill.safe { background: linear-gradient(90deg, var(--green), #00cc6a); box-shadow: 0 0 12px rgba(0,255,136,0.4); }
  .risk-gauge-fill.warn { background: linear-gradient(90deg, var(--amber), #f59e0b); box-shadow: 0 0 12px rgba(251,191,36,0.4); }
  .risk-gauge-fill.danger { background: linear-gradient(90deg, var(--red), #ff1744); box-shadow: 0 0 12px rgba(255,51,102,0.5); }

  .strategy-card {
    padding: 12px 14px;
    background: linear-gradient(135deg, rgba(15,15,22,0.8) 0%, rgba(10,10,16,0.9) 100%);
    border: 1px solid rgba(255,255,255,0.05);
    border-radius: 8px;
    margin-bottom: 10px;
    font-size: 11px;
    transition: all 0.3s ease;
  }
  .strategy-card:hover {
    border-color: rgba(0,212,255,0.2);
    box-shadow: 0 0 20px rgba(0,212,255,0.05);
  }
  .strategy-name { font-weight: 600; color: var(--text); }
  .strategy-meta { font-size: 10px; color: var(--text-dim); margin-top: 5px; }

  .report-item:hover { background: rgba(0,212,255,0.08); }

  .perf-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
  }
  .perf-metric {
    padding: 10px 12px;
    background: rgba(0,0,0,0.3);
    border: 1px solid rgba(0,212,255,0.1);
    border-radius: 6px;
    display: flex;
    flex-direction: column;
    gap: 4px;
    transition: all 0.3s;
  }
  .perf-metric:hover {
    border-color: rgba(0,212,255,0.25);
    box-shadow: 0 0 16px rgba(0,212,255,0.08);
  }
  .perf-metric-label { font-size: 9px; color: var(--text-dim); letter-spacing: 0.1em; }
  .perf-metric-val { font-family: var(--mono); font-size: 13px; font-weight: 700; }
  .perf-metric-val.pos { color: var(--green); text-shadow: 0 0 10px rgba(0,255,136,0.3); }
  .perf-metric-val.neg { color: var(--red); text-shadow: 0 0 10px rgba(255,51,102,0.3); }

  /* Center column */
  .equity-chart-wrap {
    position: relative;
    height: 220px;
    flex: 1;
    min-height: 200px;
    background: linear-gradient(180deg, rgba(0,212,255,0.02) 0%, transparent 100%);
    border-radius: 8px;
    padding: 8px;
  }

  .goal-bar-track {
    height: 8px;
    background: var(--bg3);
    border-radius: 4px;
    overflow: hidden;
    box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);
  }
  .goal-bar-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--green), #00cc6a);
    border-radius: 4px;
    transition: width 0.5s cubic-bezier(0.4,0,0.2,1);
    box-shadow: 0 0 12px rgba(0,255,136,0.4);
  }
  .goal-card .goal-bar-fill { background: linear-gradient(90deg, var(--green), #00cc6a); }
  .goal-card[data-negative="true"] .goal-bar-fill { background: linear-gradient(90deg, var(--red), #ff1744); box-shadow: 0 0 12px rgba(255,51,102,0.4); }

  /* Positions table */
  .positions-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 11px;
  }
  .positions-table th {
    text-align: left;
    padding: 10px 12px;
    font-size: 9px;
    font-weight: 700;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    color: var(--text-dim);
    border-bottom: 1px solid rgba(255,255,255,0.08);
    background: linear-gradient(180deg, rgba(0,212,255,0.03) 0%, transparent 100%);
  }
  .positions-table td {
    padding: 10px;
    border-bottom: 1px solid rgba(255,255,255,0.04);
  }
  .positions-table tbody tr { transition: background 0.15s; }
  .positions-table tbody tr:hover { background: rgba(255,255,255,0.02); }
  .positions-table tbody tr.pulse-win { animation: row-pulse-green 0.5s; }
  .positions-table tbody tr.pulse-loss { animation: row-pulse-red 0.5s; }
  @keyframes row-pulse-green { 0% { background: rgba(0,255,136,0.15); } 100% { background: transparent; } }
  @keyframes row-pulse-red { 0% { background: rgba(255,51,85,0.15); } 100% { background: transparent; } }

  .badge-yes {
    padding: 3px 8px;
    border-radius: 4px;
    background: linear-gradient(135deg, rgba(0,255,136,0.15) 0%, rgba(0,255,136,0.05) 100%);
    border: 1px solid rgba(0,255,136,0.3);
    color: var(--green);
    font-size: 9px;
    font-weight: 700;
    letter-spacing: 0.05em;
    text-shadow: 0 0 10px rgba(0,255,136,0.3);
  }
  .badge-no {
    padding: 3px 8px;
    border-radius: 4px;
    background: linear-gradient(135deg, rgba(255,51,102,0.15) 0%, rgba(255,51,102,0.05) 100%);
    border: 1px solid rgba(255,51,102,0.3);
    color: var(--red);
    font-size: 9px;
    font-weight: 700;
    letter-spacing: 0.05em;
  }

  .pos-market { max-width: 160px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

  .empty-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 48px 24px;
    color: var(--text-dim);
    font-size: 12px;
    letter-spacing: 0.05em;
  }
  .empty-state::before {
    content: '◇';
    font-size: 28px;
    opacity: 0.15;
    margin-bottom: 12px;
  }
  .empty-state svg { width: 48px; height: 48px; opacity: 0.3; margin-bottom: 12px; }

  /* Trade log */
  .trade-log {
    overflow-y: auto;
    max-height: 280px;
    flex: 1;
  }
  .trade-log::-webkit-scrollbar { width: 6px; }
  .trade-log::-webkit-scrollbar-track { background: transparent; }
  .trade-log::-webkit-scrollbar-thumb { background: rgba(0,212,255,0.15); border-radius: 3px; }
  .trade-log::-webkit-scrollbar-thumb:hover { background: rgba(0,212,255,0.25); }

  .trade-row {
    display: grid;
    grid-template-columns: 48px 1fr 44px 56px 72px 64px 1fr;
    gap: 8px;
    align-items: center;
    padding: 10px 12px;
    font-size: 11px;
    border-bottom: 1px solid rgba(255,255,255,0.04);
    transition: all 0.3s ease;
    animation: tradeSlideIn 0.35s ease;
  }
  @keyframes tradeSlideIn {
    from { opacity: 0; transform: translateX(-12px); }
    to { opacity: 1; transform: translateX(0); }
  }
  .trade-row.win {
    background: linear-gradient(90deg, rgba(0,255,136,0.06) 0%, transparent 100%);
    border-left: 2px solid rgba(0,255,136,0.4);
  }
  .trade-row.loss {
    background: linear-gradient(90deg, rgba(255,51,102,0.06) 0%, transparent 100%);
    border-left: 2px solid rgba(255,51,102,0.4);
  }
  .trade-row:hover { background: rgba(255,255,255,0.04); }

  /* Bot log */
  .log-scroll {
    overflow-y: auto;
    max-height: 200px;
    font-family: var(--mono);
    font-size: 10px;
    line-height: 1.6;
  }
  .log-scroll::-webkit-scrollbar { width: 4px; }
  .log-line { padding: 2px 4px; white-space: pre-wrap; word-break: break-word; }
  .log-line.info { color: rgba(232,232,240,0.65); }
  .log-line.warning { color: var(--amber); }
  .log-line.error { color: var(--red); background: rgba(255,51,85,0.06); }

  /* Market conditions */
  .market-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px solid rgba(255,255,255,0.04);
    font-size: 12px;
  }
  .market-label { color: var(--text-dim); }
  .market-val { font-family: var(--mono); font-weight: 600; }
  .market-val.up { color: var(--green); }
  .market-val.down { color: var(--red); }

  .charts-row {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 16px;
    padding: 20px 24px;
    background: linear-gradient(180deg, rgba(6,6,12,0.98) 0%, rgba(3,3,8,0.99) 100%);
    border-top: 1px solid rgba(0,212,255,0.1);
    flex-shrink: 0;
    box-shadow: 0 -4px 40px rgba(0,0,0,0.4), inset 0 1px 0 rgba(0,212,255,0.03);
  }
  .chart-panel {
    background: linear-gradient(145deg, rgba(8,8,16,0.9) 0%, rgba(4,4,10,0.95) 100%);
    border: 1px solid rgba(0,212,255,0.12);
    border-radius: 12px;
    padding: 16px;
    transition: all 0.3s;
  }
  .chart-panel:hover {
    border-color: rgba(0,212,255,0.25);
    box-shadow: 0 0 30px rgba(0,212,255,0.06);
  }
  .chart-icon {
    color: var(--blue);
    margin-right: 6px;
    font-size: 10px;
    animation: iconPulse 2s ease-in-out infinite;
  }
  @keyframes iconPulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.6; }
  }
  .chart-wrap { height: 100px; }
  @media (max-width: 1200px) {
    .charts-row { grid-template-columns: 1fr 1fr; }
  }
  @media (max-width: 768px) {
    .charts-row { grid-template-columns: 1fr; }
  }

  /* Staggered entrance */
  .col-left .panel-card:nth-child(1) { animation: panelIn 0.6s ease 0.1s both; }
  .col-left .panel-card:nth-child(2) { animation: panelIn 0.6s ease 0.18s both; }
  .col-left .panel-card:nth-child(3) { animation: panelIn 0.6s ease 0.26s both; }
  .col-center .panel-title { animation: panelIn 0.5s ease 0.15s both; }
  .col-right .panel-card:nth-child(1) { animation: panelIn 0.6s ease 0.2s both; }
  .col-right .panel-card:nth-child(2) { animation: panelIn 0.6s ease 0.3s both; }
  .col-right .panel-card:nth-child(3) { animation: panelIn 0.6s ease 0.4s both; }
  @keyframes panelIn {
    from { opacity: 0; transform: translateY(16px); }
    to { opacity: 1; transform: translateY(0); }
  }

  /* Skeletons */
  .skeleton {
    background: linear-gradient(90deg, var(--bg3) 25%, var(--bg2) 50%, var(--bg3) 75%);
    background-size: 200% 100%;
    animation: skeleton 1.5s ease-in-out infinite;
    border-radius: 2px;
  }
  @keyframes skeleton {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
  }

  .skeleton-text { height: 14px; }
  .skeleton-value { height: 20px; width: 60%; }
</style>
</head>
<body>
<div class="scanlines" aria-hidden="true"></div>
<div class="corner-brackets" aria-hidden="true"></div>
<div class="app">

  <!-- Header -->
  <header>
    <div class="logo">POLY<span>TERMINAL</span></div>

    <div class="header-stats" id="header-stats">
      <div class="hstat">
        <div class="hstat-label">Bankroll</div>
        <div class="hstat-value blue" id="h-bankroll">—</div>
      </div>
      <div class="hstat">
        <div class="hstat-label">Session P&L</div>
        <div class="hstat-value" id="h-pnl">—</div>
        <div class="hstat-sub" id="h-pnl-pct">—</div>
      </div>
      <div class="hstat goal-stat">
        <div class="hstat-label">Daily Goal</div>
        <div class="hstat-value" id="h-goal">—</div>
        <div class="hstat-sub" id="h-goal-pct">—</div>
      </div>
      <div class="hstat">
        <div class="hstat-label">Win Rate</div>
        <div class="hstat-value" id="h-winrate">—</div>
      </div>
      <div class="hstat">
        <div class="hstat-label">Trades Today</div>
        <div class="hstat-value blue" id="h-trades">—</div>
      </div>
    </div>

    <div class="cycle-timer-wrap" id="cycle-timer-wrap">
      <div class="cycle-label">15m Cycle</div>
      <div class="cycle-value" id="cycle-countdown">—:——</div>
      <div class="cycle-bar"><div class="cycle-bar-fill" id="cycle-bar-fill" style="width:100%"></div></div>
    </div>
    <div class="header-right">
      <div class="conn-indicator">
        <div class="conn-dot" id="conn-dot"></div>
        <span id="conn-text">Connecting</span>
      </div>
      <div class="clock-wrap">
        <div class="clock-utc" id="clock-utc">—:—:— UTC</div>
        <div class="clock-local" id="clock-local">—</div>
      </div>
      <div class="status-pill stopped" id="status-pill">
        <div class="status-dot"></div>
        <span id="status-text">STOPPED</span>
      </div>
    </div>
  </header>

  <!-- Main Grid -->
  <div class="main-grid">

    <!-- LEFT COLUMN (30%) -->
    <div class="col-left" style="overflow-y:auto">
      <div class="panel panel-card" style="flex-shrink:0">
        <div class="panel-title">Bot Health <span class="panel-update" id="health-update">—</span></div>
        <div class="risk-gauge-wrap">
          <div class="risk-gauge">
            <div class="risk-gauge-fill safe" id="risk-gauge-fill" style="width:0%"></div>
          </div>
          <span id="risk-pct" style="font-size:10px;color:var(--text-dim)">0%</span>
        </div>
        <div style="font-size:10px;color:var(--text-dim);margin-bottom:12px">Daily loss limit used</div>
        <div id="health-content">
          <div class="market-row"><span class="market-label">Status</span><span class="market-val" id="health-status">—</span></div>
          <div class="market-row"><span class="market-label">Trades/Hour</span><span class="market-val" id="health-trades-hr">—</span></div>
          <div class="market-row"><span class="market-label">Min Edge</span><span class="market-val" id="health-min-edge">—</span></div>
        </div>
        <div class="strategy-cards" id="strategy-cards">
          <div class="strategy-card"><span class="strategy-name">BTC Signal</span><span class="strategy-meta" id="strat-btc">—</span></div>
          <div class="strategy-card"><span class="strategy-name">Maker</span><span class="strategy-meta" id="strat-maker">—</span></div>
        </div>
      </div>

      <div class="panel panel-card perf-metrics">
        <div class="panel-title">Performance Metrics <span class="panel-update" id="perf-update">—</span></div>
        <div class="perf-grid">
          <div class="perf-metric">
            <span class="perf-metric-label">Profit Factor</span>
            <span class="perf-metric-val" id="perf-pf">—</span>
          </div>
          <div class="perf-metric">
            <span class="perf-metric-label">Avg Win</span>
            <span class="perf-metric-val pos" id="perf-avg-win">—</span>
          </div>
          <div class="perf-metric">
            <span class="perf-metric-label">Avg Loss</span>
            <span class="perf-metric-val neg" id="perf-avg-loss">—</span>
          </div>
          <div class="perf-metric">
            <span class="perf-metric-label">Largest Win</span>
            <span class="perf-metric-val pos" id="perf-max-win">—</span>
          </div>
          <div class="perf-metric">
            <span class="perf-metric-label">Largest Loss</span>
            <span class="perf-metric-val neg" id="perf-max-loss">—</span>
          </div>
          <div class="perf-metric">
            <span class="perf-metric-label">Streak</span>
            <span class="perf-metric-val" id="perf-streak">—</span>
          </div>
        </div>
      </div>

      <div class="panel panel-card">
        <div class="panel-title">Market Conditions <span class="panel-update" id="market-update">—</span></div>
        <div id="market-content">
          <div class="market-row"><span class="market-label">BTC</span><span class="market-val" id="market-btc">—</span></div>
          <div class="market-row"><span class="market-label">ETH</span><span class="market-val" id="market-eth">—</span></div>
          <div class="market-row"><span class="market-label">BTC Funding</span><span class="market-val" id="market-btc-funding">—</span></div>
          <div class="market-row"><span class="market-label">ETH Funding</span><span class="market-val" id="market-eth-funding">—</span></div>
          <div class="market-row"><span class="market-label">Markets Scanned</span><span class="market-val" id="market-scanned">—</span></div>
          <div class="market-row"><span class="market-label">Markets w/ Edge</span><span class="market-val" id="market-edge">—</span></div>
        </div>
      </div>
    </div>

    <!-- CENTER COLUMN (40%) -->
    <div class="col-center panel">
      <div class="panel-title">Equity Curve <span class="panel-update" id="equity-update">—</span></div>
      <div class="equity-chart-wrap">
        <canvas id="equity-chart"></canvas>
      </div>

      <div class="panel-title" style="margin-top:12px">Open Positions <span class="panel-update" id="pos-count-badge">0</span></div>
      <div style="flex:1;min-height:0;overflow:auto">
        <table class="positions-table" id="positions-table">
          <thead>
            <tr>
              <th>Market</th>
              <th>Side</th>
              <th>Size</th>
              <th>Entry</th>
              <th>Price</th>
              <th>P&L</th>
              <th>Open</th>
            </tr>
          </thead>
          <tbody id="positions-body">
            <tr><td colspan="7"><div class="empty-state">No open positions</div></td></tr>
          </tbody>
        </table>
      </div>

      <div class="panel-title" style="margin-top:12px">Goal Progress</div>
      <div class="panel-card goal-card">
        <div style="display:flex;justify-content:space-between;margin-bottom:10px;font-size:12px">
          <span style="color:var(--text-dim)">Daily P&L</span>
          <span id="goal-daily-pnl" style="font-weight:700;text-shadow:0 0 12px currentColor">—</span>
        </div>
        <div class="goal-bar-track">
          <div id="goal-bar-fill" class="goal-bar-fill" style="width:0%"></div>
        </div>
        <div style="font-size:11px;color:var(--text-dim);margin-top:8px"><span id="goal-progress-text">$0 / $1,000 — 0%</span></div>
      </div>
    </div>

    <!-- RIGHT COLUMN (30%) -->
    <div class="col-right" style="overflow-y:auto">
      <div class="panel panel-card" style="flex:1;min-height:0;display:flex;flex-direction:column">
        <div class="panel-title">Trade Log <span class="panel-update" id="trades-update">—</span></div>
        <div class="trade-log" id="trade-log" style="flex:1">
          <div class="empty-state" id="trades-empty">No trades yet</div>
        </div>
      </div>
      <div class="panel panel-card" style="flex-shrink:0">
        <div class="panel-title">Win / Loss <span class="panel-update" id="winloss-update">—</span></div>
        <div style="height:140px;position:relative">
          <canvas id="winloss-chart"></canvas>
        </div>
      </div>
      <div class="panel panel-card" style="flex-shrink:0;flex:1;min-height:0;display:flex;flex-direction:column">
        <div class="panel-title">Live Log <span class="panel-update" id="log-update">—</span></div>
        <div class="log-scroll" id="log-tail" style="flex:1">
          <div class="log-line info">Connecting...</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bottom Charts Row -->
  <div class="charts-row">
    <div class="chart-panel">
      <div class="panel-title" style="border:none;padding:0;margin:0 0 10px 0">
        <span class="chart-icon">◆</span> 7-Day P&L
      </div>
      <div class="chart-wrap"><canvas id="daily-pnl-chart"></canvas></div>
    </div>
    <div class="chart-panel">
      <div class="panel-title" style="border:none;padding:0;margin:0 0 10px 0">
        <span class="chart-icon">◆</span> Activity by Hour
      </div>
      <div class="chart-wrap"><canvas id="trades-by-hour-chart"></canvas></div>
    </div>
    <div class="chart-panel">
      <div class="panel-title" style="border:none;padding:0;margin:0 0 10px 0">
        <span class="chart-icon">◆</span> P&L by Strategy
      </div>
      <div class="chart-wrap"><canvas id="strategy-pnl-chart"></canvas></div>
    </div>
    <div class="chart-panel">
      <div class="panel-title" style="border:none;padding:0;margin:0 0 10px 0">
        <span class="chart-icon">◆</span> Exit Reasons
      </div>
      <div class="chart-wrap"><canvas id="exit-reason-chart"></canvas></div>
    </div>
    <div class="chart-panel">
      <div class="panel-title" style="border:none;padding:0;margin:0 0 10px 0">
        <span class="chart-icon">◆</span> P&L Distribution
      </div>
      <div class="chart-wrap"><canvas id="pnl-dist-chart"></canvas></div>
    </div>
    <div class="chart-panel">
      <div class="panel-title" style="border:none;padding:0;margin:0 0 10px 0">
        <span class="chart-icon">◆</span> Trades per Day (14d)
      </div>
      <div class="chart-wrap"><canvas id="daily-trades-chart"></canvas></div>
    </div>
  </div>

  <!-- Reports Section -->
  <div class="reports-section" style="margin-top:24px;padding:20px;background:var(--bg2);border:1px solid var(--border);border-radius:12px;">
    <div class="panel-title" style="margin-bottom:16px;">
      <span>Reports</span>
      <button id="btn-generate-report" class="btn-generate-report" style="margin-left:auto;padding:8px 16px;background:var(--blue);color:var(--bg);border:none;border-radius:6px;font-size:11px;font-weight:700;cursor:pointer;">Generate Now</button>
    </div>
    <div class="reports-list" id="reports-list" style="max-height:280px;overflow-y:auto;">
      <div class="empty-state" id="reports-empty">No reports yet. Click "Generate Now" to create one.</div>
    </div>
    <div id="report-detail" style="display:none;margin-top:16px;padding:16px;background:var(--bg3);border-radius:8px;border:1px solid var(--border);"></div>
  </div>
</div>

<script>
(function() {
  const params = new URLSearchParams(window.location.search);
  const base = params.get('api') || 'http://localhost:8000';
  window.API = base.replace(/\/$/, '');
  window.WS_URL = (base.startsWith('https') ? base.replace('https', 'wss') : base.replace('http', 'ws')).replace(/\/$/, '') + '/ws';
})();
const API = window.API;
const WS_URL = window.WS_URL;

// ── State ────────────────────────────────────────────────────────────────────
let state = {
  running: false, bankroll: null, starting_bankroll: null, session_pnl: 0,
  win_rate: 0, trades_today: 0, open_positions: [], status: 'stopped', paper_trading: false,
};
let trades = [];
let marketPrices = null;
let equityChart = null;
let dailyPnlChart = null;
let winLossChart = null;
let tradesByHourChart = null;
let strategyPnlChart = null;
let exitReasonChart = null;
let pnlDistChart = null;
let dailyTradesChart = null;
let ws = null;
let pollTimers = [];
let hasReceivedData = false;
let lastPnlForGlow = null;

function fmtNum(v, decimals = 2) {
  if (v == null || v === '' || (typeof v === 'number' && isNaN(v))) return '—';
  return typeof v === 'number' ? v.toFixed(decimals) : String(v);
}

// ── Polymarket 15m Cycle Timer ─────────────────────────────────────────────
function getNextQuarterHourUTC() {
  const now = new Date();
  const min = now.getUTCMinutes();
  const nextBoundaryMin = Math.ceil(min / 15) * 15;
  let next = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate(), now.getUTCHours(), 0, 0, 0));
  if (nextBoundaryMin >= 60) { next.setUTCHours(next.getUTCHours() + 1); next.setUTCMinutes(0); }
  else { next.setUTCMinutes(nextBoundaryMin); }
  let ts = next.getTime();
  if (ts <= now.getTime()) ts += 15 * 60 * 1000;
  return ts;
}
function getCurrentCycleStartUTC() {
  const now = new Date();
  const min = now.getUTCMinutes();
  const boundaryMin = Math.floor(min / 15) * 15;
  return new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate(), now.getUTCHours(), boundaryMin, 0, 0)).getTime();
}
function updateCycleTimer() {
  const now = Date.now();
  const nextBoundary = getNextQuarterHourUTC();
  const cycleStart = getCurrentCycleStartUTC();
  const cycleDuration = 15 * 60 * 1000;
  let secsRemaining = Math.floor((nextBoundary - now) / 1000);
  if (secsRemaining <= 0) secsRemaining = 15 * 60;
  const elapsed = now - cycleStart;
  const pctRemaining = Math.min(100, Math.max(0, 100 - (elapsed / cycleDuration) * 100));
  const m = Math.floor(secsRemaining / 60);
  const s = secsRemaining % 60;
  const countEl = document.getElementById('cycle-countdown');
  const barEl = document.getElementById('cycle-bar-fill');
  if (countEl) countEl.textContent = `${m}:${String(s).padStart(2, '0')}`;
  if (barEl) barEl.style.width = pctRemaining + '%';
}

// ── Clock (UTC + local) ─────────────────────────────────────────────────────
function updateClock() {
  const now = new Date();
  const utc = now.toISOString().slice(11, 19);
  const local = now.toLocaleTimeString('en-US', { hour12: false });
  const utcEl = document.getElementById('clock-utc');
  const localEl = document.getElementById('clock-local');
  if (utcEl) utcEl.textContent = utc + ' UTC';
  if (localEl) localEl.textContent = local;
}
setInterval(updateClock, 1000);
updateClock();

// ── Connection status ───────────────────────────────────────────────────────
function setConnected(connected) {
  const dot = document.getElementById('conn-dot');
  const text = document.getElementById('conn-text');
  if (dot) {
    dot.classList.toggle('disconnected', !connected);
  }
  if (text) text.textContent = connected ? 'Live' : 'Disconnected';
}

// ── Charts ──────────────────────────────────────────────────────────────────
function initCharts() {
  const equityCtx = document.getElementById('equity-chart');
  if (equityCtx) {
    const ctx = equityCtx.getContext('2d');
    const grad = ctx.createLinearGradient(0, 0, 0, 200);
    grad.addColorStop(0, 'rgba(0,255,136,0.25)');
    grad.addColorStop(0.5, 'rgba(0,255,136,0.06)');
    grad.addColorStop(1, 'rgba(0,255,136,0)');
    equityChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: [],
        datasets: [{
          label: 'Equity',
          data: [],
          borderColor: '#00ff88',
          borderWidth: 2.5,
          fill: true,
          backgroundColor: grad,
          tension: 0.4,
          pointRadius: 0,
          pointHoverRadius: 6,
          pointHoverBackgroundColor: '#00ff88',
          pointHoverBorderColor: '#00ff88',
          pointHoverBorderWidth: 2,
        }]
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        animation: { duration: 500 },
        plugins: {
          legend: { display: false },
          tooltip: {
            backgroundColor: 'rgba(8,8,14,0.95)',
            borderColor: 'rgba(0,212,255,0.4)',
            borderWidth: 1,
            padding: 12,
            titleFont: { size: 11 },
            bodyFont: { size: 13, family: 'JetBrains Mono' },
            callbacks: { label: c => c.raw != null ? `$${Number(c.raw).toFixed(2)}` : '' }
          }
        },
        scales: {
          x: { display: false },
          y: {
            grid: { color: 'rgba(255,255,255,0.03)' },
            ticks: { color: '#4a4a6a', font: { size: 10 }, callback: v => '$' + v }
          }
        }
      }
    });
  }

  const dailyCtx = document.getElementById('daily-pnl-chart');
  if (dailyCtx) {
    dailyPnlChart = new Chart(dailyCtx.getContext('2d'), {
      type: 'bar',
      data: { labels: [], datasets: [{ data: [], backgroundColor: [], borderRadius: 4 }] },
      options: {
        responsive: true, maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: {
          x: { ticks: { color: '#4a4a6a', maxRotation: 0, font: { size: 10 } }, grid: { display: false } },
          y: { ticks: { color: '#4a4a6a', font: { size: 10 }, callback: v => '$' + v }, grid: { color: 'rgba(255,255,255,0.03)' } }
        }
      }
    });
  }

  const tradesByHourCtx = document.getElementById('trades-by-hour-chart');
  if (tradesByHourCtx) {
    tradesByHourChart = new Chart(tradesByHourCtx.getContext('2d'), {
      type: 'bar',
      data: { labels: [], datasets: [{ data: [], backgroundColor: 'rgba(0,212,255,0.5)', borderColor: 'rgba(0,212,255,0.8)', borderWidth: 1 }] },
      options: {
        responsive: true, maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: {
          x: { ticks: { color: '#4a4a6a', maxRotation: 0, font: { size: 9 } }, grid: { display: false } },
          y: { ticks: { color: '#4a4a6a', font: { size: 9 }, stepSize: 1 }, grid: { color: 'rgba(255,255,255,0.03)' } }
        }
      }
    });
  }

  const strategyPnlCtx = document.getElementById('strategy-pnl-chart');
  if (strategyPnlCtx) {
    strategyPnlChart = new Chart(strategyPnlCtx.getContext('2d'), {
      type: 'bar',
      data: { labels: [], datasets: [{ data: [], backgroundColor: [], borderRadius: 4 }] },
      options: {
        indexAxis: 'y',
        responsive: true, maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: {
          x: { ticks: { color: '#4a4a6a', font: { size: 9 }, callback: v => '$' + v }, grid: { color: 'rgba(255,255,255,0.03)' } },
          y: { ticks: { color: '#7878a0', font: { size: 10 } }, grid: { display: false } }
        }
      }
    });
  }

  const exitReasonCtx = document.getElementById('exit-reason-chart');
  if (exitReasonCtx) {
    exitReasonChart = new Chart(exitReasonCtx.getContext('2d'), {
      type: 'doughnut',
      data: { labels: [], datasets: [{ data: [], backgroundColor: ['#00ff88', '#ff3366', '#ffaa00', '#00d4ff', '#7878a0'], borderWidth: 0 }] },
      options: {
        responsive: true, maintainAspectRatio: false,
        cutout: '60%',
        plugins: { legend: { position: 'bottom', labels: { color: '#7878a0', font: { size: 9 } } } }
      }
    });
  }

  const pnlDistCtx = document.getElementById('pnl-dist-chart');
  if (pnlDistCtx) {
    pnlDistChart = new Chart(pnlDistCtx.getContext('2d'), {
      type: 'bar',
      data: { labels: [], datasets: [{ data: [], backgroundColor: [], borderRadius: 4 }] },
      options: {
        responsive: true, maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: {
          x: { ticks: { color: '#4a4a6a', maxRotation: 45, font: { size: 8 } }, grid: { display: false } },
          y: { ticks: { color: '#4a4a6a', font: { size: 9 }, stepSize: 1 }, grid: { color: 'rgba(255,255,255,0.03)' } }
        }
      }
    });
  }

  const dailyTradesCtx = document.getElementById('daily-trades-chart');
  if (dailyTradesCtx) {
    dailyTradesChart = new Chart(dailyTradesCtx.getContext('2d'), {
      type: 'bar',
      data: { labels: [], datasets: [{ data: [], backgroundColor: 'rgba(0,212,255,0.5)', borderRadius: 4 }] },
      options: {
        responsive: true, maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: {
          x: { ticks: { color: '#4a4a6a', maxRotation: 45, font: { size: 9 } }, grid: { display: false } },
          y: { ticks: { color: '#4a4a6a', font: { size: 9 }, stepSize: 1 }, grid: { color: 'rgba(255,255,255,0.03)' } }
        }
      }
    });
  }

  const winLossCtx = document.getElementById('winloss-chart');
  if (winLossCtx) {
    winLossChart = new Chart(winLossCtx.getContext('2d'), {
      type: 'doughnut',
      data: {
        labels: ['Wins', 'Losses'],
        datasets: [{
          data: [0, 0],
          backgroundColor: ['rgba(0,255,136,0.9)', 'rgba(255,51,102,0.9)'],
          borderWidth: 0,
          hoverOffset: 4
        }]
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        cutout: '70%',
        plugins: {
          legend: { position: 'bottom', labels: { color: '#7878a0', font: { size: 11 } } },
          tooltip: { callbacks: { label: c => `${c.label}: ${c.raw}` } }
        }
      },
      plugins: [{
        id: 'centerLabel',
        beforeDraw: (chart) => {
          const wins = chart.data.datasets[0].data[0] || 0;
          const losses = chart.data.datasets[0].data[1] || 0;
          const total = wins + losses;
          const pct = total > 0 ? ((wins / total) * 100).toFixed(1) : '0';
          const ctx = chart.ctx;
          ctx.save();
          ctx.font = 'bold 20px JetBrains Mono';
          ctx.fillStyle = '#f0f0f8';
          ctx.textAlign = 'center';
          ctx.textBaseline = 'middle';
          ctx.fillText(pct + '%', chart.width / 2, chart.height / 2);
          ctx.restore();
        }
      }]
    });
  }
}

// ── Update equity chart ─────────────────────────────────────────────────────
function updateEquityChart() {
  if (!equityChart) return;
  const startBr = state.starting_bankroll ?? state.bankroll ?? 1000;
  const closed = (trades || []).filter(t => t.pnl_usdc != null && t.exit_time);
  closed.sort((a,b) => (a.exit_time||'').localeCompare(b.exit_time||''));

  const labels = [];
  const data = [];
  let running = startBr;
  for (const t of closed) {
    running += parseFloat(t.pnl_usdc || 0);
    labels.push((t.exit_time||'').slice(11, 16) || '—');
    data.push(parseFloat(running.toFixed(2)));
  }
  if (closed.length > 0) {
    labels.push('Now');
    data.push(state.bankroll ?? running);
  } else if (state.bankroll != null) {
    labels.push('Now');
    data.push(state.bankroll);
  } else {
    labels.push('Start');
    data.push(startBr);
  }

  equityChart.data.labels = labels;
  equityChart.data.datasets[0].data = data;
  equityChart.update('none');

  const up = document.getElementById('equity-update');
  if (up && hasReceivedData) up.textContent = new Date().toLocaleTimeString('en-US', { hour12: false });
}

const STRATEGY_COLORS = {
  btc_momentum: ['rgba(247,147,26,0.8)', '#f7931a'],
  eth_lag: ['rgba(138,43,226,0.8)', '#a78bfa'],
  sol_squeeze: ['rgba(0,199,140,0.8)', '#00c78c'],
  maker: ['rgba(0,212,255,0.8)', '#00d4ff'],
  xrp_catalyst: ['rgba(33,150,243,0.8)', '#42a5f5'],
  base: ['rgba(0,212,255,0.6)', '#00d4ff'],
};

async function updateCharts() {
  try {
    const res = await fetch(`${API}/api/chart-data`).then(r => r.json()).catch(() => null);
    if (res) {
      if (dailyPnlChart && res.daily_pnl_7d?.length) {
        const d = [...res.daily_pnl_7d].reverse();
        const today = new Date().toISOString().slice(0, 10);
        dailyPnlChart.data.labels = d.map(x => x.date.slice(5) === today.slice(5) ? x.date.slice(5) + ' ★' : x.date.slice(5));
        dailyPnlChart.data.datasets[0].data = d.map(x => x.pnl);
        dailyPnlChart.data.datasets[0].backgroundColor = d.map((x, i) => {
          const isToday = d[i].date === today;
          return x.pnl >= 0
            ? (isToday ? 'rgba(0,255,136,0.9)' : 'rgba(0,255,136,0.7)')
            : (isToday ? 'rgba(255,51,102,0.9)' : 'rgba(255,51,102,0.7)');
        });
        dailyPnlChart.update('none');
      }
      if (tradesByHourChart && res.trades_by_hour?.length) {
        tradesByHourChart.data.labels = res.trades_by_hour.map(x => String(x.hour).padStart(2, '0') + ':00');
        tradesByHourChart.data.datasets[0].data = res.trades_by_hour.map(x => x.count);
        tradesByHourChart.data.datasets[0].backgroundColor = res.trades_by_hour.map(x =>
          x.count > 0 ? 'rgba(0,212,255,0.6)' : 'rgba(0,212,255,0.15)');
        tradesByHourChart.update('none');
      }
      if (exitReasonChart && res.exit_reason_dist?.length) {
        exitReasonChart.data.labels = res.exit_reason_dist.map(x => x.reason.replace(/_/g, ' '));
        exitReasonChart.data.datasets[0].data = res.exit_reason_dist.map(x => x.count);
        const colors = ['#00ff88', '#ff3366', '#ffaa00', '#00d4ff', '#a78bfa', '#7878a0'];
        exitReasonChart.data.datasets[0].backgroundColor = res.exit_reason_dist.map((_, i) => colors[i % colors.length]);
        exitReasonChart.update('none');
      }
      if (pnlDistChart && res.pnl_histogram?.length) {
        pnlDistChart.data.labels = res.pnl_histogram.map(x => x.label);
        pnlDistChart.data.datasets[0].data = res.pnl_histogram.map(x => x.count);
        pnlDistChart.data.datasets[0].backgroundColor = res.pnl_histogram.map((x, i) =>
          i < 4 ? 'rgba(255,51,102,0.6)' : 'rgba(0,255,136,0.6)');
        pnlDistChart.update('none');
      }
      if (dailyTradesChart && res.daily_trades_14d?.length) {
        const d = res.daily_trades_14d;
        const today = new Date().toISOString().slice(0, 10);
        dailyTradesChart.data.labels = d.map(x => x.date.slice(5));
        dailyTradesChart.data.datasets[0].data = d.map(x => x.count);
        dailyTradesChart.data.datasets[0].backgroundColor = d.map(x =>
          x.date === today ? 'rgba(0,255,136,0.7)' : 'rgba(0,212,255,0.5)');
        dailyTradesChart.update('none');
      }
    }
    if (strategyPnlChart && trades?.length) {
      const byStrategy = {};
      for (const t of trades.filter(x => x.pnl_usdc != null && x.exit_time)) {
        const s = (t.strategy || 'other').toLowerCase().replace(/[^a-z0-9]/g, '_').replace(/_+/g, '_') || 'other';
        byStrategy[s] = (byStrategy[s] || 0) + parseFloat(t.pnl_usdc || 0);
      }
      const labels = Object.keys(byStrategy).map(k => k.replace(/_/g, ' '));
      strategyPnlChart.data.labels = labels.length ? labels : ['No data'];
      strategyPnlChart.data.datasets[0].data = labels.length ? Object.values(byStrategy) : [0];
      strategyPnlChart.data.datasets[0].backgroundColor = labels.map((_, i) => {
        const k = Object.keys(byStrategy)[i];
        return (STRATEGY_COLORS[k] || STRATEGY_COLORS.base)[0];
      });
      strategyPnlChart.update('none');
    }
  } catch (_) {}
}

// ── Render Header ───────────────────────────────────────────────────────────
function renderHeader(s) {
  const bankroll = s.bankroll ?? s.starting_bankroll;
  const start = s.starting_bankroll ?? bankroll ?? 1000;
  const curr = bankroll ?? start;
  const sessionPnl = s.session_pnl ?? 0;
  const pnlPct = s.session_pnl_pct ?? (start > 0 ? (sessionPnl / start) * 100 : 0);
  const goalTrack = s.goal_tracking || {};
  const goal = goalTrack.daily_goal_usd ?? 1000;
  const dailyPnl = goalTrack.daily_pnl ?? sessionPnl;
  const progressPct = goalTrack.progress_pct ?? (goal > 0 ? (dailyPnl / goal) * 100 : 0);

  const bankrollEl = document.getElementById('h-bankroll');
  if (bankrollEl) {
    setWithPulse(bankrollEl, curr != null ? '$' + fmtNum(curr) : '—');
    bankrollEl.className = 'hstat-value ' + (sessionPnl >= 0 ? 'glowing-green' : sessionPnl < 0 ? 'glowing-red' : 'blue');
  }

  const pnlEl = document.getElementById('h-pnl');
  if (pnlEl) {
    setWithPulse(pnlEl, sessionPnl != null ? (sessionPnl >= 0 ? '+' : '') + '$' + fmtNum(sessionPnl) : '—');
    pnlEl.className = 'hstat-value ' + (sessionPnl >= 0 ? 'positive' : 'negative');
  }
  const pctEl = document.getElementById('h-pnl-pct');
  if (pctEl) pctEl.textContent = pnlPct != null ? (pnlPct >= 0 ? '+' : '') + fmtNum(pnlPct) + '%' : '—';

  const goalEl = document.getElementById('h-goal');
  if (goalEl) goalEl.textContent = dailyPnl != null && goal != null ? `$${fmtNum(dailyPnl)} / $${fmtNum(goal)}` : '—';
  const goalPctEl = document.getElementById('h-goal-pct');
  if (goalPctEl) goalPctEl.textContent = progressPct != null ? fmtNum(progressPct) + '%' : '—';

  const wrEl = document.getElementById('h-winrate');
  if (wrEl) wrEl.textContent = (s.win_rate ?? s.trade_stats?.win_rate_all) != null ? fmtNum(s.win_rate ?? s.trade_stats?.win_rate_all, 1) + '%' : '—';

  const tradesEl = document.getElementById('h-trades');
  if (tradesEl) tradesEl.textContent = (s.trades_today ?? s.trade_stats?.trades_today ?? 0);

  // Status pill
  const pill = document.getElementById('status-pill');
  const txt = document.getElementById('status-text');
  const st = s.status ?? (s.running ? 'running' : 'stopped');
  if (pill && txt) {
    pill.className = 'status-pill ' + (s.paper_trading ? 'paper' : st);
    txt.textContent = s.paper_trading ? 'PAPER' : st === 'running' ? 'LIVE' : st === 'error' ? 'ERROR' : 'STOPPED';
  }
}

// ── Render Goal ─────────────────────────────────────────────────────────────
function renderGoal(s) {
  const gt = s.goal_tracking || {};
  const dailyPnl = gt.daily_pnl ?? s.session_pnl ?? 0;
  const goal = gt.daily_goal_usd ?? 1000;
  const progressPct = Math.min(100, Math.max(0, goal > 0 ? (dailyPnl / goal) * 100 : 0));

  const pnlEl = document.getElementById('goal-daily-pnl');
  if (pnlEl) {
    pnlEl.textContent = dailyPnl != null ? (dailyPnl >= 0 ? '+' : '') + '$' + fmtNum(dailyPnl) : '—';
    pnlEl.style.color = dailyPnl >= 0 ? 'var(--green)' : 'var(--red)';
  }
  const barFill = document.getElementById('goal-bar-fill');
  const goalCard = document.querySelector('.goal-card');
  if (barFill) barFill.style.width = progressPct + '%';
  if (goalCard) goalCard.setAttribute('data-negative', dailyPnl < 0 ? 'true' : 'false');
  const progEl = document.getElementById('goal-progress-text');
  if (progEl) progEl.textContent = `$${fmtNum(dailyPnl)} / $${fmtNum(goal)} — ${fmtNum(progressPct, 1)}%`;
}

// ── Render Health ───────────────────────────────────────────────────────────
function renderHealth(s) {
  const lossPct = s.daily_loss_limit_used_pct ?? 0;
  const bar = document.getElementById('risk-gauge-fill');
  const pctEl = document.getElementById('risk-pct');
  if (bar) {
    bar.style.width = Math.min(100, lossPct) + '%';
    bar.className = 'risk-gauge-fill ' + (lossPct > 80 ? 'danger' : lossPct > 50 ? 'warn' : 'safe');
  }
  if (pctEl) pctEl.textContent = fmtNum(lossPct, 0) + '%';

  const set = (id, v) => { const e = document.getElementById(id); if (e) e.textContent = v != null && v !== '' ? v : '—'; };
  set('health-status', s.running ? 'Scanning' : 'Stopped');
  set('health-trades-hr', s.trade_stats?.trades_per_hour != null ? fmtNum(s.trade_stats.trades_per_hour, 1) : '—');
  set('health-min-edge', s.config?.min_edge_pct != null ? s.config.min_edge_pct + '%' : '—');

  const btcEl = document.getElementById('strat-btc');
  if (btcEl) {
    const a = s.bot_activity || {};
    if (a.btc_signal_fired && a.btc_signal_side && a.btc_pct_move != null) {
      btcEl.textContent = `${a.btc_signal_side} ${(a.btc_pct_move * 100).toFixed(2)}%`;
      btcEl.style.color = 'var(--green)';
    } else {
      btcEl.textContent = 'Inactive';
      btcEl.style.color = 'var(--text-dim)';
    }
  }
  const makerEl = document.getElementById('strat-maker');
  if (makerEl) {
    makerEl.textContent = s.bot_activity?.maker_active ? 'Active' : 'Off';
    makerEl.style.color = s.bot_activity?.maker_active ? 'var(--green)' : 'var(--text-dim)';
  }

  const up = document.getElementById('health-update');
  if (up && hasReceivedData) up.textContent = new Date().toLocaleTimeString('en-US', { hour12: false });
}

// ── Render Performance Metrics ─────────────────────────────────────────────
function renderPerf(s) {
  const stats = s.trade_stats || {};
  const set = (id, v) => { const e = document.getElementById(id); if (e) e.textContent = v != null && v !== '' ? String(v) : '—'; };
  set('perf-pf', stats.profit_factor != null ? stats.profit_factor.toFixed(2) : '—');
  set('perf-avg-win', stats.avg_win != null ? '$' + stats.avg_win.toFixed(2) : '—');
  set('perf-avg-loss', stats.avg_loss != null ? '$' + stats.avg_loss.toFixed(2) : '—');
  set('perf-max-win', stats.largest_win != null ? '$' + stats.largest_win.toFixed(2) : '—');
  set('perf-max-loss', stats.largest_loss != null ? '$' + stats.largest_loss.toFixed(2) : '—');
  set('perf-streak', stats.streak && stats.streak_type ? stats.streak + ' ' + stats.streak_type : '—');
  const up = document.getElementById('perf-update');
  if (up && hasReceivedData) up.textContent = new Date().toLocaleTimeString('en-US', { hour12: false });
}

// ── Render Market ───────────────────────────────────────────────────────────
function renderMarket(s, prices) {
  const set = (id, v) => { const e = document.getElementById(id); if (e) e.textContent = v != null && v !== '' ? v : '—'; };
  set('market-scanned', s.bot_activity?.markets_last_scan);
  set('market-edge', s.bot_activity?.markets_with_edge);

  if (prices) {
    if (prices.btc_usd != null) {
      const el = document.getElementById('market-btc');
      if (el) {
        const change = prices.btc_24h_change;
        el.innerHTML = '$' + Number(prices.btc_usd).toLocaleString(undefined, {maximumFractionDigits: 0}) +
          (change != null ? ` <span class="${change >= 0 ? 'up' : 'down'}">(${change >= 0 ? '+' : ''}${Number(change).toFixed(2)}%)</span>` : '');
      }
    } else set('market-btc', '—');
    if (prices.eth_usd != null) {
      const el = document.getElementById('market-eth');
      if (el) {
        const change = prices.eth_24h_change;
        el.innerHTML = '$' + Number(prices.eth_usd).toLocaleString(undefined, {maximumFractionDigits: 0}) +
          (change != null ? ` <span class="${change >= 0 ? 'up' : 'down'}">(${change >= 0 ? '+' : ''}${Number(change).toFixed(2)}%)</span>` : '');
      }
    } else set('market-eth', '—');
    const btcFr = prices.btc_funding;
    const ethFr = prices.eth_funding;
    const frStr = (v, label) => v != null ? v.toFixed(4) + '% ' + (v > 0 ? '(longs pay)' : v < 0 ? '(shorts pay)' : '') : '—';
    const btcFrEl = document.getElementById('market-btc-funding');
    const ethFrEl = document.getElementById('market-eth-funding');
    if (btcFrEl) btcFrEl.textContent = frStr(btcFr, 'BTC');
    if (ethFrEl) ethFrEl.textContent = frStr(ethFr, 'ETH');
  } else {
    set('market-btc', '—');
    set('market-eth', '—');
    set('market-btc-funding', '—');
    set('market-eth-funding', '—');
  }

  const up = document.getElementById('market-update');
  if (up && hasReceivedData) up.textContent = new Date().toLocaleTimeString('en-US', { hour12: false });
}

// ── Render Positions ─────────────────────────────────────────────────────────
function renderPositions(positions) {
  const tbody = document.getElementById('positions-body');
  const badge = document.getElementById('pos-count-badge');
  if (!tbody) return;

  if (!positions || positions.length === 0) {
    tbody.innerHTML = '<tr><td colspan="7"><div class="empty-state">No open positions</div></td></tr>';
    if (badge) badge.textContent = '0';
    return;
  }

  if (badge) badge.textContent = positions.length;

  tbody.innerHTML = positions.map(pos => {
    const entryP = parseFloat(pos.entry_price || 0);
    const currP = parseFloat(pos.current_price || entryP);
    const shares = parseFloat(pos.shares || 0);
    const pnl = (currP - entryP) * shares;
    const sizeUsdc = parseFloat(pos.size_usdc || 0);
    const entryTime = pos.entry_time ? new Date(pos.entry_time) : null;
    const openDur = entryTime ? formatDuration((Date.now() - entryTime.getTime()) / 1000) : '—';

    return `<tr>
      <td class="pos-market" title="${escHtml(pos.question||'')}">${escHtml((pos.question||'').slice(0, 35))}</td>
      <td><span class="badge-${(pos.side||'').toLowerCase()}">${pos.side || '?'}</span></td>
      <td>$${fmtNum(sizeUsdc)}</td>
      <td>${fmtNum(entryP, 3)}</td>
      <td>${fmtNum(currP, 3)}</td>
      <td style="color:${pnl >= 0 ? 'var(--green)' : 'var(--red)'};font-weight:600">${pnl >= 0 ? '+' : ''}$${fmtNum(pnl)}</td>
      <td>${openDur}</td>
    </tr>`;
  }).join('');
}

// ── Render Trades ───────────────────────────────────────────────────────────
function renderTrades(tradeList) {
  const container = document.getElementById('trade-log');
  const empty = document.getElementById('trades-empty');
  const updateEl = document.getElementById('trades-update');

  if (!container) return;
  if (updateEl && hasReceivedData) updateEl.textContent = new Date().toLocaleTimeString('en-US', { hour12: false });

  if (!tradeList || tradeList.length === 0) {
    container.innerHTML = '<div class="empty-state" id="trades-empty">No trades yet</div>';
    return;
  }

  const sorted = [...tradeList].sort((a,b) => (b.exit_time||'').localeCompare(a.exit_time||''));
  const existing = container.querySelectorAll('.trade-row');
  const frag = document.createDocumentFragment();

  sorted.slice(0, 50).forEach((t, i) => {
    const pnl = parseFloat(t.pnl_usdc || 0);
    const isWin = pnl > 0;
    const row = document.createElement('div');
    row.className = 'trade-row ' + (isWin ? 'win' : 'loss');
    row.innerHTML = `
      <span>${(t.exit_time||'').slice(11, 19)}</span>
      <span class="pos-market" title="${escHtml(t.question||'')}">${escHtml((t.question||'').slice(0, 25))}</span>
      <span class="badge-${(t.side||'').toLowerCase()}">${t.side||'?'}</span>
      <span>$${fmtNum(parseFloat(t.size_usdc||0))}</span>
      <span>${fmtNum(parseFloat(t.entry_price||0), 2)}→${t.exit_price ? fmtNum(parseFloat(t.exit_price), 2) : '—'}</span>
      <span style="color:${isWin ? 'var(--green)' : 'var(--red)'};font-weight:600">${pnl >= 0 ? '+' : ''}$${fmtNum(pnl)}</span>
      <span>${(t.strategy||'—').replace(/_/g,' ')}</span>
    `;
    frag.appendChild(row);
  });

  container.innerHTML = '';
  container.appendChild(frag);
}

// ── Render Win/Loss chart ───────────────────────────────────────────────────
function updateWinLossChart() {
  if (!winLossChart) return;
  const closed = (trades || []).filter(t => t.pnl_usdc != null && t.exit_time);
  const wins = closed.filter(t => parseFloat(t.pnl_usdc || 0) > 0).length;
  const losses = closed.length - wins;
  winLossChart.data.datasets[0].data = [wins, losses];
  winLossChart.update('none');

  const up = document.getElementById('winloss-update');
  if (up && hasReceivedData) up.textContent = new Date().toLocaleTimeString('en-US', { hour12: false });
}

// ── Render Logs ─────────────────────────────────────────────────────────────
function renderLogs(lines) {
  const el = document.getElementById('log-tail');
  const up = document.getElementById('log-update');
  if (up && hasReceivedData) up.textContent = new Date().toLocaleTimeString('en-US', { hour12: false });
  if (!el) return;

  el.innerHTML = (lines || []).map(line => {
    const lvl = line.includes('| ERROR') ? 'error' : line.includes('| WARNING') ? 'warning' : 'info';
    return `<div class="log-line ${lvl}">${escHtml(line)}</div>`;
  }).join('') || '<div class="log-line info">No log output</div>';

  el.scrollTop = el.scrollHeight;
}

// ── Helpers ─────────────────────────────────────────────────────────────────
function formatDuration(secs) {
  secs = Math.max(0, Math.floor(secs));
  const m = Math.floor(secs / 60);
  const s = secs % 60;
  return `${m}:${String(s).padStart(2, '0')}`;
}

function escHtml(str) {
  return String(str||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

function setWithPulse(el, text) {
  if (!el) return;
  if (el.textContent !== text) {
    el.textContent = text;
    el.classList.remove('data-pulse');
    void el.offsetWidth;
    el.classList.add('data-pulse');
    setTimeout(() => el.classList.remove('data-pulse'), 500);
  }
}

// ── Reports ──────────────────────────────────────────────────────────────────
async function loadReports() {
  try {
    const res = await fetch(`${API}/api/reports`).then(r => r.json()).catch(() => ({ reports: [] }));
    renderReportsList(res.reports || []);
  } catch (_) {}
}

function renderReportsList(reports) {
  const list = document.getElementById('reports-list');
  if (!list) return;
  if (!reports || reports.length === 0) {
    list.innerHTML = '<div class="empty-state" id="reports-empty">No reports yet. Click "Generate Now" to create one.</div>';
    return;
  }
  list.innerHTML = reports.map(r => {
    const ps = r.summary || {};
    const pnl = ps.net_pnl_usd ?? 0;
    const pct = ps.net_pnl_pct ?? 0;
    const col = pnl >= 0 ? 'var(--green)' : 'var(--red)';
    return `<div class="report-item" data-date="${r.date}" style="display:flex;justify-content:space-between;align-items:center;padding:12px;border-bottom:1px solid var(--border);cursor:pointer;">
      <span>${r.date}</span>
      <span style="color:${col};font-weight:600">${pnl >= 0 ? '+' : ''}$${Number(pnl).toFixed(2)} (${pct >= 0 ? '+' : ''}${Number(pct).toFixed(1)}%)</span>
      <span style="font-size:11px;color:var(--text-dim)">${ps.total_trades ?? 0} trades</span>
      <a href="${API}/api/reports/${r.date}/csv" download="report-${r.date}.csv" onclick="event.stopPropagation()" style="padding:4px 8px;font-size:10px;background:var(--bg3);border-radius:4px;color:var(--blue);text-decoration:none;">CSV</a>
    </div>`;
  }).join('');

  list.querySelectorAll('.report-item').forEach(el => {
    el.addEventListener('click', () => expandReport(el.dataset.date));
  });
}

async function expandReport(date) {
  const detailEl = document.getElementById('report-detail');
  if (!detailEl) return;
  try {
    const res = await fetch(`${API}/api/reports/${date}`).then(r => r.json());
    if (res.error) {
      detailEl.innerHTML = `<p style="color:var(--red)">${res.error}</p>`;
    } else {
      const ps = res.performance_summary || {};
      const crypto = res.crypto_performance || {};
      const risk = res.risk_summary || {};
      const mc = res.market_conditions || {};
      const pnl = ps.net_pnl_usd ?? 0;
      const col = pnl >= 0 ? 'var(--green)' : 'var(--red)';
      let stratRows = '';
      for (const [name, data] of Object.entries(crypto.by_strategy || {})) {
        const c = data.pnl >= 0 ? 'var(--green)' : 'var(--red)';
        stratRows += `<tr><td>${name}</td><td style="color:${c}">$${Number(data.pnl).toFixed(2)}</td><td>${data.trades}</td></tr>`;
      }
      detailEl.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
          <strong>Report — ${date}</strong>
          <div>
            <a href="${API}/api/reports/${date}/csv" download="report-${date}.csv" style="margin-right:8px;padding:6px 12px;font-size:11px;background:var(--blue);color:var(--bg);border-radius:6px;text-decoration:none;">Download CSV</a>
            <button onclick="window.print()" style="padding:6px 12px;font-size:11px;background:var(--bg3);color:var(--text);border:1px solid var(--border);border-radius:6px;cursor:pointer;">Print / Save PDF</button>
          </div>
        </div>
        <div style="font-size:12px;line-height:1.8;">
          <p style="font-size:16px;font-weight:700;color:${col}">${pnl >= 0 ? '+' : ''}$${Number(pnl).toFixed(2)} (${(ps.net_pnl_pct ?? 0) >= 0 ? '+' : ''}${Number(ps.net_pnl_pct ?? 0).toFixed(1)}%)</p>
          <p>Starting: $${Number(ps.starting_bankroll ?? 0).toFixed(2)} → Ending: $${Number(ps.ending_bankroll ?? 0).toFixed(2)} | Trades: ${ps.total_trades ?? 0} | Win rate: ${Number(ps.win_rate ?? 0).toFixed(1)}%</p>
          <table style="margin-top:12px;width:100%;border-collapse:collapse;"><tr><th style="text-align:left;padding:6px">Strategy</th><th>P&L</th><th>Trades</th></tr>${stratRows || '<tr><td colspan="3">—</td></tr>'}</table>
          <p style="margin-top:12px;color:var(--text-dim)">Risk: Loss limit triggered ${risk.loss_limit_triggered ? 'Yes' : 'No'} | BTC: $${mc.btc_usd ?? '—'} | ETH: $${mc.eth_usd ?? '—'}</p>
        </div>`;
    }
    detailEl.style.display = 'block';
  } catch (e) {
    detailEl.innerHTML = `<p style="color:var(--red)">Failed to load report</p>`;
    detailEl.style.display = 'block';
  }
}

document.getElementById('btn-generate-report')?.addEventListener('click', async () => {
  const btn = document.getElementById('btn-generate-report');
  if (btn) { btn.disabled = true; btn.textContent = 'Generating...'; }
  try {
    const res = await fetch(`${API}/api/generate-report?send_email=false&send_discord=false`).then(r => r.json());
    if (res.success) {
      await loadReports();
      const date = res.date;
      const detailEl = document.getElementById('report-detail');
      if (date && detailEl) { expandReport(date); detailEl.style.display = 'block'; }
    }
  } catch (_) {}
  if (btn) { btn.disabled = false; btn.textContent = 'Generate Now'; }
});

// ── WebSocket ───────────────────────────────────────────────────────────────
function connectWS() {
  try {
    ws = new WebSocket(WS_URL);

    ws.onopen = () => {
      setConnected(true);
      renderLogs(['Connected to bot WebSocket']);
    };

    ws.onmessage = (evt) => {
      try {
        const msg = JSON.parse(evt.data);
        if (msg.type === 'update') {
          hasReceivedData = true;
          document.querySelector('.app')?.setAttribute('data-loading', 'false');
          state = { ...state, ...(msg.status || {}) };
          if (Array.isArray(msg.recent_trades) && msg.recent_trades.length > 0) trades = msg.recent_trades;

          renderHeader(state);
          renderGoal(state);
          renderHealth(state);
          renderPerf(state);
          renderPositions(state.open_positions || []);
          renderMarket(state, marketPrices);
          renderTrades(trades);
          updateEquityChart();
          updateWinLossChart();
          updateCharts();
          if (msg.logs) renderLogs(msg.logs);
        }
      } catch (e) { console.error('WS parse error', e); }
    };

    ws.onerror = () => {
      setConnected(false);
      renderLogs(['WebSocket error — check server']);
    };

    ws.onclose = () => {
      setConnected(false);
      renderLogs(['Disconnected. Reconnecting...']);
      setTimeout(connectWS, 3000);
    };
  } catch (e) {
    setConnected(false);
    renderLogs(['WebSocket failed: ' + (e.message || 'unknown')]);
    setTimeout(connectWS, 3000);
  }
}

// ── Polling fallback & balance / market ─────────────────────────────────────
async function pollStatus() {
  if (ws && ws.readyState === WebSocket.OPEN) return;
  try {
    const res = await fetch(`${API}/api/status`).then(r => r.json()).catch(() => null);
    if (res) {
      hasReceivedData = true;
      document.querySelector('.app')?.setAttribute('data-loading', 'false');
      state = { ...state, ...res };
      renderHeader(state);
      renderGoal(state);
      renderHealth(state);
      renderPerf(state);
      renderPositions(state.open_positions || []);
      renderMarket(state, marketPrices);
    }
  } catch (_) {}
}

async function pollTrades() {
  try {
    const res = await fetch(`${API}/api/trades`).then(r => r.json()).catch(() => null);
    if (res && res.trades && res.trades.length > 0) {
      trades = res.trades;
      renderTrades(trades);
      updateEquityChart();
      updateWinLossChart();
    }
  } catch (_) {}
}

async function pollLogs() {
  if (ws && ws.readyState === WebSocket.OPEN) return;
  try {
    const res = await fetch(`${API}/api/logs`).then(r => r.json()).catch(() => null);
    if (res && res.lines) renderLogs(res.lines);
  } catch (_) {}
}

async function pollBalance() {
  try {
    const res = await fetch(`${API}/api/balance`).then(r => r.json()).catch(() => null);
    if (res && res.balance_usdc != null) {
      state.bankroll = res.balance_usdc;
      state.starting_bankroll = res.starting_bankroll ?? state.starting_bankroll;
      state.session_pnl = res.session_pnl ?? state.session_pnl;
      renderHeader(state);
      renderGoal(state);
      updateEquityChart();
    }
  } catch (_) {}
}

async function pollMarketPrices() {
  try {
    const res = await fetch(`${API}/api/market-prices`).then(r => r.json()).catch(() => null);
    if (res) {
      marketPrices = res;
      renderMarket(state, marketPrices);
    }
  } catch (_) {}
}

// ── Init ────────────────────────────────────────────────────────────────────
document.addEventListener('DOMContentLoaded', () => {
  initCharts();
  connectWS();

  const interval = 8000;
  pollTimers.push(setInterval(pollStatus, interval));
  pollTimers.push(setInterval(pollTrades, interval));
  pollTimers.push(setInterval(pollLogs, interval));
  pollTimers.push(setInterval(pollBalance, interval));
  pollTimers.push(setInterval(pollMarketPrices, interval));
  loadReports();
  pollTimers.push(setInterval(loadReports, 60000));

  updateCycleTimer();
  setInterval(updateCycleTimer, 1000);

  // Initial fetch (allSettled = one failure doesn't break others)
  Promise.allSettled([
    fetch(`${API}/api/status`).then(r => r.json()),
    fetch(`${API}/api/trades`).then(r => r.json()),
    fetch(`${API}/api/logs`).then(r => r.json()),
    fetch(`${API}/api/market-prices`).then(r => r.json()),
    fetch(`${API}/api/balance`).then(r => r.json()),
    fetch(`${API}/api/reports`).then(r => r.json()),
  ]).then(([s, t, l, p, b, r]) => {
    const status = s.status === 'fulfilled' ? s.value : null;
    const tradesRes = t.status === 'fulfilled' ? t.value : null;
    const logsRes = l.status === 'fulfilled' ? l.value : null;
    const prices = p.status === 'fulfilled' ? p.value : null;
    const balance = b.status === 'fulfilled' ? b.value : null;
    if (status) { state = { ...state, ...status }; renderHeader(state); renderGoal(state); renderHealth(state); renderPerf(state); renderPositions(state.open_positions||[]); }
    if (tradesRes?.trades?.length) { trades = tradesRes.trades; renderTrades(trades); updateEquityChart(); updateWinLossChart(); updateCharts(); }
    if (logsRes?.lines) renderLogs(logsRes.lines);
    if (prices) { marketPrices = prices; renderMarket(state, marketPrices); }
    if (balance && balance.balance_usdc != null) { state.bankroll = balance.balance_usdc; state.starting_bankroll = balance.starting_bankroll; state.session_pnl = balance.session_pnl; renderHeader(state); renderGoal(state); }
    const reportsRes = r.status === 'fulfilled' ? r.value : null;
    if (reportsRes?.reports?.length) renderReportsList(reportsRes.reports);
    updateCharts();
    hasReceivedData = true;
    setConnected(true);
    document.querySelector('.app')?.setAttribute('data-loading', 'false');
  }).catch(() => { document.querySelector('.app')?.setAttribute('data-loading', 'false'); });
  document.querySelector('.app')?.setAttribute('data-loading', 'true');
});

window.addEventListener('beforeunload', () => {
  pollTimers.forEach(t => clearInterval(t));
  if (ws) ws.close();
});
</script>
</body>
</html>
